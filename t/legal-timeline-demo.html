<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Legal Timeline Demo — TRUS</title>

<!-- общий CSS сайта -->
<link rel="stylesheet" href="https://therealunrealstory.com/assets/styles.css" />

<style>
:root{
  --indigo-300:#a5b4fc;
  --indigo-600:#4f46e5;
  --red-500:#ef4444;

  --tl-gutter-h:6%;
  --tl-gutter-v:8%;

  --lineY:62%;
  --freeze-offset:16px;

  --label-gap:18px;
}

body{margin:0; color:#e7ecf3; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
.wrap{ max-width:1100px; margin:28px auto; padding:0 16px; }
.roadmap-head{ background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:16px 18px; margin-bottom:16px; }
.roadmap-title{ margin:0 0 6px 0; font-size:22px; }
.roadmap-meta{ color:rgba(231,236,243,.7); font-size:14px; }

.timeline{ position:relative; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:16px;
  overflow:hidden; width: min(1400px, calc(100vw - 32px));
  margin-left: max(16px, calc(50% - 50vw + 16px));
  margin-right: max(16px, calc(50% - 50vw + 16px));
}
.track{ position:relative; width:100%; height:360px; }

/* линии */
.pre-cause-line{ position:absolute; height:2px; background:var(--indigo-300); top:calc(var(--lineY) - 1px); z-index:3; border-radius:2px; }
.base-line{ position:absolute; height:4px; background:var(--indigo-600); top:var(--lineY); transform:translateY(-50%); z-index:2; }
.freeze-line{ position:absolute; height:12px; background:var(--red-500); border-radius:8px; top: calc(var(--lineY) + var(--freeze-offset)); z-index:3; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25)); }
.future-line{ position:absolute; height:4px; background:transparent; top:var(--lineY); transform:translateY(-50%); z-index:2; border-top:4px dashed var(--indigo-600); }

/* точки */
.cluster-dot{ position:absolute; width:16px; height:16px; border-radius:50%; background:#fff; outline:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 0 2px rgba(79,70,229,.45); cursor:pointer; transform:translate(-50%, -50%); z-index:4; }

/* подписи */
.label{ position:absolute; font-size:12px; color:rgba(231,236,243,.75); white-space:nowrap; text-shadow:0 1px 0 rgba(0,0,0,.35); line-height:1.1; }
@media (min-width:821px){
  .label{ top: var(--lineY); transform: translate(-50%, calc(-100% - var(--label-gap))) rotate(180deg); writing-mode: vertical-rl; text-orientation: mixed; }
}

/* маркер сейчас */
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(165,180,252,.6);}70%{box-shadow:0 0 0 12px rgba(165,180,252,0);}100%{box-shadow:0 0 0 0 rgba(165,180,252,0);} }
.now-marker{ position:absolute; background:#a5b4fc; border-radius:2px; animation:pulse 1.9s ease-out infinite; z-index:5; }

/* легенда */
.legend{ display:flex; gap:18px; flex-wrap:wrap; padding:10px 12px; border-top:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.05); font-size:13px; color:rgba(231,236,243,.9); }
.legend-item{ display:flex; align-items:center; gap:8px; }
.legend-swatch{ height:6px; border-radius:4px; }
.swatch-pre{ width:44px; background:var(--indigo-300); }
.swatch-base{ width:44px; background:var(--indigo-600); }
.swatch-freeze{ width:44px; height:12px; background:var(--red-500); border-radius:8px; }
.swatch-future{ width:44px; background:transparent; border-top:4px dashed var(--indigo-600); height:0; }
.swatch-dot{ width:16px; height:16px; border-radius:50%; background:#fff; outline:1px solid rgba(255,255,255,0.12); box-shadow:0 0 0 2px rgba(79,70,229,.45); }

/* НОВОЕ: стили для деталей */
.js-morebox{ font-style:italic; color:#dfe7fb; margin-top:6px; }

/* мобайл */
@media (max-width:820px){
  .track{ height:1200px; }
  .pre-cause-line{ left:44px; width:2px; transform:none; }
  .base-line{ left:44px; width:4px; transform:none; }
  .freeze-line{ left: calc(44px - var(--freeze-offset)); width:12px; height:auto; }
  .future-line{ left:44px; width:0; height:auto; border-top:none; border-left:4px dashed var(--indigo-600); transform:none; }
  .cluster-dot{ left:44px; transform:translate(-50%,0); }
  .label{ left:60px; transform:none; }
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="roadmap-head">
      <h1 class="roadmap-title">Юридическая хронология (демо)</h1>
      <div class="roadmap-meta" id="meta">Загрузка…</div>
    </div>
  </div>

  <div class="timeline">
    <div class="track" id="track">
      <div class="pre-cause-line" id="preLine"></div>
      <div class="base-line" id="baseLine"></div>
      <div class="freeze-line" id="freezeLine"></div>
      <div class="future-line" id="futureLine"></div>
      <div class="now-marker" id="now"></div>
    </div>
    <div class="legend">
      <div class="legend-item"><span class="legend-swatch swatch-pre"></span><span>Предпосылки (до иска)</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-base"></span><span>Период судебных разбирательств</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-freeze"></span><span>Период блокировки</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-future"></span><span>Судебные перспективы (впереди)</span></div>
      <div class="legend-item"><span class="swatch-dot"></span><span>Событие <span style="opacity:.8">(кликабельно)</span></span></div>
    </div>
  </div>

  <!-- модалка -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0 0 8px 0"></h3>
      <div id="modalBody"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
        <button id="modalClose" class="btn" type="button">Закрыть</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  const res = await fetch('./legal-timeline.json',{cache:'no-store'});
  if(!res.ok){ document.getElementById('meta').textContent='Не удалось загрузить legal-timeline.json'; return; }
  const data = await res.json();

  const parseYM=s=>{ if(!s) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00Z'); if(/^\d{4}-\d{2}$/.test(s)) return new Date(s+'-01T00:00:00Z'); if(/^\d{4}$/.test(s)) return new Date(s+'-01-01T00:00:00Z'); return new Date(s); };
  const esc=s=>String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const NBSP='\u00A0'; const RU_MON=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
  const isMobile=()=>matchMedia('(max-width:820px)').matches;

  const items=(data.items||[]).slice().sort((a,b)=>parseYM(a.date_start)-parseYM(b.date_start));
  document.getElementById('meta').textContent=`Обновлено: ${new Date(data.meta.updated_at).toLocaleString()} • ${data.meta.updated_by} • версия: ${data.meta.version}`;

  /* ... setLineSegments etc (без изменений) ... */

  const modal=document.getElementById('modalBackdrop');
  const mTitle=document.getElementById('modalTitle');
  const mBody=document.getElementById('modalBody');
  const mClose=document.getElementById('modalClose');

  function openModal(title,html){
    mTitle.innerHTML=title||''; mBody.innerHTML=html||'';
    modal.classList.add('show'); document.body.classList.add('modal-open');
  }
  function closeModal(){ modal.classList.remove('show'); document.body.classList.remove('modal-open'); }
  mClose.addEventListener('click',closeModal);
  modal.addEventListener('click',e=>{if(e.target===modal) closeModal();});
  document.addEventListener('keydown',e=>{if(e.key==='Escape'&&modal.classList.contains('show')) closeModal();});

  function openModalSingle(it){
    const more=it.details?`
      <div class="js-morebox" style="display:none">${esc(it.details)}</div>
      <p><button class="btn js-more">Подробнее</button></p>`:'';
    openModal(`${esc(it.when_label||'')} — ${esc(it.title||'')}`,
      `<div class="muted" style="margin-bottom:8px">${esc(it.summary||'')}</div>${more}`);
  }
  function openModalCluster(group){
    const list=group.map(it=>`
      <div style="padding-top:10px; margin-top:10px; border-top:1px dashed rgba(255,255,255,.12)">
        <div style="font-weight:600">${esc(it.title||'')}</div>
        <div class="muted" style="margin:4px 0 6px 0">${esc(it.when_label||'')}</div>
        <div>${esc(it.summary||'')}</div>
        ${it.details?`<div class="js-morebox" style="display:none">${esc(it.details)}</div><button class="btn js-more" style="margin-top:6px">Подробнее</button>`:''}
      </div>`).join('');
    openModal(`События (${group.length})`,list);
  }

  // делегирование
  document.getElementById('modalBody').addEventListener('click',e=>{
    const btn=e.target.closest('.js-more'); if(!btn) return;
    const box=btn.previousElementSibling; if(!box) return;
    const opened=box.style.display!=='none'; box.style.display=opened?'none':'block';
    btn.textContent=opened?'Подробнее':'Свернуть';
  });
})();
</script>
</body>
</html>
