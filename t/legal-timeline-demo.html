<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Legal Timeline Demo (roadmap‑style)</title>
<style>
  /* ---- БАЗА в духе мед. хронологии ---- */
  :root{
    /* фон/текст */
    --bg-grad-1:#0b0f18; --bg-grad-2:#0a1122;
    --text:#e7ecf3; --muted:#a9b4c0; --border:rgba(255,255,255,.12);
    --panel:rgba(255,255,255,.05); --panel-2:rgba(255,255,255,.08);

    /* основная линия — ИНДИГО (как акцент в TRUS) */
    --indigo:#6366f1;          /* линия */
    --indigo-soft:#a5b4fc;     /* glow / now */

    /* роли (под мед. блок, близкие оттенки) */
    --role-plaintiff:#f59e0b;  /* янтарный */
    --role-defendant:#3b82f6;  /* синий */
    --role-court:#a78bfa;      /* фиолетовый */
    --role-admin:#10b981;      /* зелёный */

    /* статусы (прозрачность) */
    --alpha-done:1;
    --alpha-current:1;
    --alpha-planned:.55;
    --alpha-tentative:.4;

    --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.35);
  }

  @keyframes roadmapPulse {
    0%   { box-shadow:0 0 0 0 rgba(165,180,252,.60); }
    70%  { box-shadow:0 0 0 12px rgba(165,180,252,0); }
    100% { box-shadow:0 0 0 0 rgba(165,180,252,0); }
  }

  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg-grad-1),var(--bg-grad-2));
    color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .roadmap-head{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
    padding:16px 18px;box-shadow:var(--shadow);margin-bottom:16px}
  .roadmap-title{margin:0 0 6px 0;font-size:22px}
  .roadmap-meta{color:var(--muted);font-size:14px}

  .timeline{position:relative;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);overflow:hidden}
  .track-scroll{position:relative;overflow:auto;-webkit-overflow-scrolling:touch}
  .track{position:relative;min-height:250px;min-width:900px}
  .line{position:absolute;left:0;right:0;top:50%;height:4px;background:var(--indigo);opacity:.72;transform:translateY(-50%)}
  .now-marker{position:absolute;top:0;bottom:0;width:3px;background:var(--indigo-soft);border-radius:2px;animation:roadmapPulse 1.9s ease-out infinite}

  /* Вертикальная ориентация на мобиле */
  @media (max-width:820px){
    .track{min-height:1000px;min-width:100%}
    .line{left:44px;width:4px;height:calc(100% - 44px);top:22px;bottom:22px;transform:none}
    .now-marker{left:0;top:0;width:100%;height:3px;bottom:auto}
  }

  /* Периоды (segments) */
  .segment{position:absolute;height:10px;border-radius:6px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
  .segment.role-plaintiff{background:var(--role-plaintiff)}
  .segment.role-defendant{background:var(--role-defendant)}
  .segment.role-court{background:var(--role-court)}
  .segment.role-admin{background:var(--role-admin)}
  .segment.status-done{opacity:var(--alpha-done)}
  .segment.status-current{opacity:var(--alpha-current)}
  .segment.status-planned{opacity:var(--alpha-planned)}
  .segment.status-tentative{opacity:var(--alpha-tentative)}

  /* Точки и кластеры */
  .dot,.cluster-dot{position:absolute;width:16px;height:16px;border-radius:50%;
    outline:1px solid var(--border);box-shadow:0 0 0 2px rgba(0,0,0,.25);cursor:pointer;transform:translate(-50%,-50%)}
  .dot.role-plaintiff,.cluster-dot.role-plaintiff{background:var(--role-plaintiff)}
  .dot.role-defendant,.cluster-dot.role-defendant{background:var(--role-defendant)}
  .dot.role-court,.cluster-dot.role-court{background:var(--role-court)}
  .dot.role-admin,.cluster-dot.role-admin{background:var(--role-admin)}
  .dot.status-planned,.cluster-dot.status-planned{opacity:var(--alpha-planned);outline-style:dashed}
  .dot.status-tentative,.cluster-dot.status-tentative{opacity:var(--alpha-tentative);outline-style:dashed}

  .cluster-badge{position:absolute;right:-8px;top:-8px;min-width:18px;height:18px;background:#0f172a;color:#c7d2fe;
    border:1px solid var(--border);border-radius:10px;padding:0 5px;font-size:11px;display:flex;align-items:center;justify-content:center}

  .label{position:absolute;transform:translate(-50%,10px);font-size:12px;color:var(--muted);white-space:nowrap;text-shadow:0 1px 0 rgba(0,0,0,.35)}

  @media (max-width:820px){
    .dot,.cluster-dot{left:44px;transform:translate(-50%,0)}
    .segment{left:44px;transform:translateX(-50%);width:8px}
    .label{left:60px;transform:none}
  }

  .hint{padding:10px 12px;color:var(--muted);font-size:13px;border-top:1px solid var(--border);background:var(--panel)}

  /* ---- MODAL (в духе TRUS: полупрозрачный фон, мягкие углы) ---- */
  .lt-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,20,.55);backdrop-filter:blur(2px);display:none;z-index:1000}
  .lt-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1001}
  .lt-modal.open,.lt-modal-backdrop.open{display:flex}
  .lt-dialog{max-width:720px;width:clamp(320px,90vw,720px);max-height:80vh;overflow:auto;background:#0f1624;
    border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px 18px}
  .lt-title{margin:0 0 6px 0;font-size:18px}
  .lt-when{color:var(--muted);font-size:13px;margin-bottom:8px}
  .lt-summary{font-size:14px;margin-bottom:10px;color:#d9e2ee}
  .lt-details{font-size:14px;color:#c8d3e0}
  .lt-actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:var(--panel-2);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .lt-close{margin-left:auto}
  .lt-divider{margin:10px 0;border-top:1px dashed var(--border)}
  .lt-list > .lt-item{padding-top:10px;margin-top:10px;border-top:1px dashed var(--border)}
  .lt-item-title{font-weight:600;margin-bottom:2px}
  .lt-item-when{color:var(--muted);font-size:13px;margin-bottom:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="roadmap-head">
      <h1 class="roadmap-title">Юридическая хронология (демо)</h1>
      <div class="roadmap-meta" id="meta">Загрузка…</div>
    </div>

    <div class="timeline roadmap-panel">
      <div class="track-scroll" id="scroll">
        <div class="track" id="track">
          <div class="line"></div>
          <div class="now-marker" id="now"></div>
          <!-- элементы рендерятся JS -->
        </div>
      </div>
      <div class="hint">Подсказка: на десктопе прокручивайте колёсиком (или Shift+колёсико) по горизонтали; нажмите на точку, чтобы открыть модальное окно.</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="lt-modal-backdrop" id="modalBack"></div>
  <div class="lt-modal" id="modal" aria-modal="true" role="dialog" aria-labelledby="ltTitle">
    <div class="lt-dialog" role="document">
      <h2 class="lt-title" id="ltTitle"></h2>
      <div class="lt-when" id="ltWhen"></div>
      <div class="lt-summary" id="ltSummary"></div>
      <div class="lt-details" id="ltDetails"></div>
      <div class="lt-list" id="ltList" style="display:none"></div>
      <div class="lt-actions">
        <button class="btn" id="toggleDetails">Подробнее</button>
        <button class="btn lt-close" id="closeModal">Закрыть</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  const res = await fetch('./legal-timeline.json', {cache:'no-store'});
  if(!res.ok){ document.getElementById('meta').textContent = 'Не удалось загрузить legal-timeline.json'; return; }
  const data = await res.json();

  /* ===== Utils ===== */
  const parseYM = s=>{
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00Z');
    if(/^\d{4}-\d{2}$/.test(s)) return new Date(s+'-01T00:00:00Z');
    if(/^\d{4}$/.test(s)) return new Date(s+'-01-01T00:00:00Z');
    return new Date(s);
  };
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const esc = s => String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  /* ===== Domain ===== */
  const items = data.items.slice().sort((a,b)=>{
    const ad = parseYM(a.date_start||a.date_end);
    const bd = parseYM(b.date_start||b.date_end);
    return ad - bd;
  });
  const firstDate = parseYM(items[0].date_start || items[0].date_end);
  const lastRef = items.reduce((d,it)=>{
    const p = parseYM(it.date_end || it.date_start);
    return p>d ? p : d;
  }, firstDate);
  const today = new Date();
  const domainStart = firstDate;
  const domainEnd = new Date(Math.max(today.getTime(), lastRef.getTime()));
  const spanMs = domainEnd - domainStart;

  const fmtMeta = iso => new Date(iso).toLocaleString();
  document.getElementById('meta').textContent =
    `Обновлено: ${fmtMeta(data.meta.updated_at)} • ${data.meta.updated_by} • версия: ${data.meta.version}`;

  const track = document.getElementById('track');
  const scroll = document.getElementById('scroll');
  const nowEl = document.getElementById('now');
  const isMobile = () => window.matchMedia('(max-width: 820px)').matches;

  function posRatio(d){ if(!d) return 0; return clamp((d - domainStart) / spanMs, 0, 1); }

  function placeNow(){
    const r = posRatio(today);
    if(isMobile()){
      // на мобиле — горизонтальная «Now» сверху
      nowEl.style.left = '0'; nowEl.style.top = '0';
      nowEl.style.right = '0'; nowEl.style.bottom = '';
      nowEl.style.height = '3px'; nowEl.style.width = '';
    } else {
      nowEl.style.left = (r*100)+'%';
      nowEl.style.top = '0'; nowEl.style.bottom = '0';
      nowEl.style.width = '3px'; nowEl.style.height = '';
    }
  }

  function roleClass(r){ return 'role-' + (r||'admin'); }
  function statusClass(s){ return 'status-' + (s||'done'); }

  /* ===== Render segments (periods) ===== */
  function isPeriod(it){
    const start = parseYM(it.date_start);
    const end = it.date_end ? parseYM(it.date_end) : null;
    return (!!start && !!end) || (!!start && it.type==='freeze' && it.status!=='done');
  }
  function renderSegment(it){
    if(!isPeriod(it)) return;
    const start = parseYM(it.date_start);
    const end = it.date_end ? parseYM(it.date_end) : null;

    const seg = document.createElement('div');
    seg.className = `segment ${roleClass(it.role)} ${statusClass(it.status)}`;
    if(isMobile()){
      const y1 = posRatio(start)*100, y2 = posRatio(end || domainEnd)*100;
      seg.style.top = `calc(${y1}% - 5px)`; seg.style.height = Math.max(2, y2 - y1) + '%';
    } else {
      const x1 = posRatio(start)*100, x2 = posRatio(end || domainEnd)*100;
      seg.style.left = x1+'%'; seg.style.top = 'calc(50% - 5px)'; seg.style.width = Math.max(2, x2 - x1) + '%';
    }
    seg.dataset.id = it.id;
    seg.addEventListener('click', ()=> openModalSingle(it));
    track.appendChild(seg);
  }

  /* ===== Clustering close events (≤ 2 months) ===== */
  const TWO_MONTHS = 1000*60*60*24*60;
  const points = items.filter(it=>!isPeriod(it));
  const clusters = [];
  for(const it of points){
    const d = parseYM(it.date_start || it.date_end);
    let c = clusters.find(x => Math.abs(x.center - d) <= TWO_MONTHS);
    if(!c){ c = { center:d, items:[] }; clusters.push(c); }
    else c.center = new Date((c.center.getTime()*c.items.length + d.getTime())/(c.items.length+1));
    c.items.push(it);
  }
  const prRole = { court:3, plaintiff:2, defendant:1, admin:0 };
  const prStatus = { current:3, done:2, planned:1, tentative:0 };
  const domRole = its => (its.slice().sort((a,b)=>(prRole[(b.role||'admin')] - prRole[(a.role||'admin')]))[0].role || 'admin');
  const domStatus = its => (its.slice().sort((a,b)=>(prStatus[(b.status||'done')] - prStatus[(a.status||'done')]))[0].status || 'done');

  /* ===== Render all ===== */
  items.forEach(renderSegment);

  clusters.forEach(c=>{
    const role = domRole(c.items), status = domStatus(c.items);
    const dot = document.createElement('div');
    dot.className = `cluster-dot ${roleClass(role)} ${statusClass(status)}`;
    if(isMobile()){
      const y = posRatio(c.center)*100; dot.style.top = `calc(${y}% - 8px)`;
    } else {
      const x = posRatio(c.center)*100; dot.style.left = x+'%'; dot.style.top = '50%';
    }

    const label = document.createElement('div');
    label.className = 'label';
    if(c.items.length===1){ label.textContent = c.items[0].when_label || ''; }
    else{
      const mind = c.items.map(i=>parseYM(i.date_start||i.date_end)).reduce((a,b)=>a<b?a:b);
      const maxd = c.items.map(i=>parseYM(i.date_start||i.date_end)).reduce((a,b)=>a>b?a:b);
      const fmt = d => d.toLocaleDateString(undefined,{year:'numeric',month:'short'});
      label.textContent = `${fmt(mind)} – ${fmt(maxd)}`;
    }

    if(c.items.length>1){
      const badge = document.createElement('div'); badge.className='cluster-badge'; badge.textContent=c.items.length; dot.appendChild(badge);
    }

    dot.addEventListener('click', ()=> {
      if(c.items.length===1) openModalSingle(c.items[0]); else openModalCluster(c.items);
    });

    track.appendChild(dot); track.appendChild(label);
  });

  placeNow();
  window.addEventListener('resize', ()=> location.reload());

  /* ===== MODAL ===== */
  const modal = document.getElementById('modal');
  const back = document.getElementById('modalBack');
  const tTitle = document.getElementById('ltTitle');
  const tWhen = document.getElementById('ltWhen');
  const tSummary = document.getElementById('ltSummary');
  const tDetails = document.getElementById('ltDetails');
  const tList = document.getElementById('ltList');
  const btnToggle = document.getElementById('toggleDetails');
  const btnClose = document.getElementById('closeModal');

  function openBackdrop(){ modal.classList.add('open'); back.classList.add('open'); trapFocus(); }
  function closeBackdrop(){ modal.classList.remove('open'); back.classList.remove('open'); releaseFocus(); }

  function openModalSingle(it){
    tList.style.display='none'; tList.innerHTML='';
    tTitle.textContent = it.title || '';
    tWhen.textContent = it.when_label || '';
    tSummary.textContent = it.summary || '';
    tDetails.innerHTML = esc(it.details || '');
    tDetails.style.display='none';
    btnToggle.style.display = it.details ? '' : 'none';
    openBackdrop();
  }

  function openModalCluster(items){
    const sorted = items.slice().sort((a,b)=>{
      const ad = parseYM(a.date_start||a.date_end), bd = parseYM(b.date_start||b.date_end);
      return ad - bd;
    });
    tTitle.textContent = `События (${sorted.length})`;
    tWhen.textContent = '';
    tSummary.textContent = 'В этом периоде сгруппированы близкие по времени события.';
    tDetails.style.display='none'; tDetails.innerHTML='';
    btnToggle.style.display='none';

    tList.innerHTML = sorted.map(it => `
      <div class="lt-item">
        <div class="lt-item-title">${esc(it.title||'')}</div>
        <div class="lt-item-when">${esc(it.when_label||'')}</div>
        <div class="lt-summary">${esc(it.summary||'')}</div>
        ${it.details ? `<div class="lt-details">${esc(it.details)}</div>` : ''}
      </div>
    `).join('');
    tList.style.display='block';
    openBackdrop();
  }

  btnToggle.addEventListener('click', ()=>{
    const vis = tDetails.style.display==='block';
    tDetails.style.display = vis ? 'none' : 'block';
    btnToggle.textContent = vis ? 'Подробнее' : 'Свернуть';
  });
  btnClose.addEventListener('click', closeBackdrop);
  back.addEventListener('click', closeBackdrop);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeBackdrop(); });

  /* focus trap для доступности */
  let lastFocus = null;
  function trapFocus(){
    lastFocus = document.activeElement;
    const focusables = modal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
    const first = focusables[0], last = focusables[focusables.length-1];
    first && first.focus();
    modal.addEventListener('keydown', onTrap);
    function onTrap(e){
      if(e.key!=='Tab') return;
      if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
    }
  }
  function releaseFocus(){ modal.removeEventListener('keydown', ()=>{}); if(lastFocus) lastFocus.focus(); }
  /* горизонтальный скролл на десктопе */
  if(!isMobile()){
    scroll.addEventListener('wheel', (e)=>{
      if(e.shiftKey || Math.abs(e.deltaX) > Math.abs(e.deltaY)){
        scroll.scrollLeft += e.deltaY + e.deltaX;
        e.preventDefault();
      }
    }, {passive:false});
  }
})();
</script>
</body>
</html>
