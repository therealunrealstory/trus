<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Legal Timeline Demo — TRUS</title>

<!-- общий CSS сайта -->
<link rel="stylesheet" href="https://therealunrealstory.com/assets/styles.css" />

<style>
:root{
  --indigo-300:#a5b4fc;
  --indigo-600:#4f46e5;
  --red-500:#ef4444;

  /* равные отступы контейнера до крайних линий */
  --tl-gutter-h:6%;
  --tl-gutter-v:8%;

  --lineY:62%;
  --freeze-offset:16px;

  --label-gap:18px; /* одинаковый зазор подписи от точки (десктоп) */
}

body{margin:0; color:#e7ecf3; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
.wrap{ max-width:1100px; margin:28px auto; padding:0 16px; }
.roadmap-head{ background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:16px 18px; margin-bottom:16px; }
.roadmap-title{ margin:0 0 6px 0; font-size:22px; }
.roadmap-meta{ color:rgba(231,236,243,.7); font-size:14px; }

.timeline{
  position:relative; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:16px;
  overflow:hidden; width: min(1400px, calc(100vw - 32px));
  margin-left: max(16px, calc(50% - 50vw + 16px));
  margin-right: max(16px, calc(50% - 50vw + 16px));
}
.track{ position:relative; width:100%; height:360px; }

/* ── ЛИНИИ ───────────────────────────────────────────────────────── */
.pre-cause-line{
  position:absolute; height:2px; background:var(--indigo-300);
  top:calc(var(--lineY) - 1px); z-index:3; border-radius:2px;
}
.base-line{
  position:absolute; height:4px; background:var(--indigo-600);
  top:var(--lineY); transform:translateY(-50%); z-index:2;
}
.freeze-line{
  position:absolute; height:12px; background:var(--red-500); border-radius:8px;
  top: calc(var(--lineY) + var(--freeze-offset)); z-index:3;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
}
.future-line{
  position:absolute; height:4px; background:transparent;
  top:var(--lineY); transform:translateY(-50%); z-index:2;
  border-top:4px dashed var(--indigo-600);
}

/* Точки/кластеры (на шкале) */
.cluster-dot{
  position:absolute; width:16px; height:16px; border-radius:50%;
  background:#ffffff; outline:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 0 2px rgba(79,70,229,.45);
  cursor:pointer; transform:translate(-50%, -50%); z-index:4;
}

/* Подписи */
.label{
  position:absolute; font-size:12px; color:rgba(231,236,243,.75);
  white-space:nowrap; text-shadow:0 1px 0 rgba(0,0,0,.35); line-height:1.1;
}
@media (min-width:821px){
  .label{
    top: var(--lineY);
    transform: translate(-50%, calc(-100% - var(--label-gap))) rotate(180deg);
    writing-mode: vertical-rl; text-orientation: mixed;
  }
}

/* Маркер «Сейчас» */
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(165,180,252,.6);}70%{box-shadow:0 0 0 12px rgba(165,180,252,0);}100%{box-shadow:0 0 0 0 rgba(165,180,252,0);} }
.now-marker{ position:absolute; background:#a5b4fc; border-radius:2px; animation:pulse 1.9s ease-out infinite; z-index:5; }

/* Легенда */
.legend{ display:flex; gap:18px; flex-wrap:wrap; padding:10px 12px; border-top:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.05); font-size:13px; color:rgba(231,236,243,.9); }
.legend-item{ display:flex; align-items:center; gap:8px; }
.legend-swatch{ height:6px; border-radius:4px; }
.swatch-pre{ width:44px; background:var(--indigo-300); }
.swatch-base{ width:44px; background:var(--indigo-600); }
.swatch-freeze{ width:44px; height:12px; background:var(--red-500); border-radius:8px; }
.swatch-future{ width:44px; background:transparent; border-top:4px dashed var(--indigo-600); height:0; }

/* НОВОЕ: образец «точки» в легенде — как на шкале */
.swatch-dot{
  width:16px; height:16px; border-radius:50%;
  background:#ffffff; outline:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 0 2px rgba(79,70,229,.45);
}

/* ── Мобильная версия ───────────────────────────────────────────── */
@media (max-width:820px){
  .track{ height:1200px; }

  /* Светлая: Сен 2020 → Июл 2021 (вертикаль) */
  .pre-cause-line{ left:44px; width:2px; transform:none; }

  /* База: Июл 2021 → Ноя 2026 (вертикаль) */
  .base-line{ left:44px; width:4px; transform:none; }

  /* Красная — СЛЕВА от базовой */
  .freeze-line{ left: calc(44px - var(--freeze-offset)); width:12px; height:auto; }

  /* Пунктир будущего — вертикальный */
  .future-line{ left:44px; width:0; height:auto; border-top:none; border-left:4px dashed var(--indigo-600); transform:none; }

  .cluster-dot{ left:44px; transform:translate(-50%,0); }
  .label{ left:60px; transform:none; }
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="roadmap-head">
      <h1 class="roadmap-title">Юридическая хронология (демо)</h1>
      <div class="roadmap-meta" id="meta">Загрузка…</div>
    </div>
  </div>

  <div class="timeline">
    <div class="track" id="track">
      <div class="pre-cause-line" id="preLine"></div>
      <div class="base-line" id="baseLine"></div>
      <div class="freeze-line" id="freezeLine"></div>
      <div class="future-line" id="futureLine"></div>
      <div class="now-marker" id="now"></div>
    </div>
    <div class="legend">
      <div class="legend-item"><span class="legend-swatch swatch-pre"></span><span>Предпосылки (до иска)</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-base"></span><span>Период судебных разбирательств</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-freeze"></span><span>Период блокировки</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-future"></span><span>Судебные перспективы (впереди)</span></div>
      <!-- НОВОЕ: точка события (кликабельно) -->
      <div class="legend-item">
        <span class="swatch-dot" aria-hidden="true"></span>
        <span>Событие <span style="opacity:.8">(кликабельно)</span></span>
      </div>
    </div>
  </div>

  <!-- универсальная модалка — те же ID/классы, что и на сайте -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0 0 8px 0"></h3>
      <div id="modalBody"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
        <button id="modalClose" class="btn" type="button">Закрыть</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  const res = await fetch('./legal-timeline.json', {cache:'no-store'});
  if(!res.ok){ document.getElementById('meta').textContent = 'Не удалось загрузить legal-timeline.json'; return; }
  const data = await res.json();

  /* ---------- helpers ---------- */
  const parseYM = s=>{
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00Z');
    if(/^\d{4}-\d{2}$/.test(s)) return new Date(s+'-01T00:00:00Z');
    if(/^\d{4}$/.test(s)) return new Date(s+'-01-01T00:00:00Z');
    return new Date(s);
  };
  const esc = s => String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const NBSP = '\u00A0';
  const RU_MON = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
  const isMobile = () => matchMedia('(max-width:820px)').matches;

  const items = (data.items||[]).slice().sort((a,b)=>{
    const ad = parseYM(a.date_start||a.date_end);
    const bd = parseYM(b.date_start||b.date_end);
    return ad - bd;
  });

  document.getElementById('meta').textContent =
    `Обновлено: ${new Date(data.meta.updated_at).toLocaleString()} • ${data.meta.updated_by} • версия: ${data.meta.version}`;

  /* ---------- domain & layout ---------- */
  const PRE_START = parseYM('2020-09-01');
  const FREEZE_START = parseYM('2021-07-01');
  const COURT_END = parseYM('2026-11-01');
  const FUTURE_MONTHS = 6;
  const FUTURE_END = new Date(COURT_END); FUTURE_END.setUTCMonth(FUTURE_END.getUTCMonth()+FUTURE_MONTHS);

  const GUTTER_H = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tl-gutter-h'))/100 || 0.06;
  const GUTTER_V = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tl-gutter-v'))/100 || 0.08;

  const domainStart = PRE_START, domainEnd = FUTURE_END, spanMs = domainEnd - domainStart;
  const posRatio = d => clamp((d - domainStart) / spanMs, 0, 1);
  const posH = r => GUTTER_H + r * (1 - GUTTER_H*2);
  const posV = r => GUTTER_V + r * (1 - GUTTER_V*2);

  const preLine = document.getElementById('preLine');
  const baseLine = document.getElementById('baseLine');
  const freezeLine = document.getElementById('freezeLine');
  const futureLine = document.getElementById('futureLine');
  const nowEl = document.getElementById('now');
  const track = document.getElementById('track');

  function setLineSegments(){
    const now = new Date();

    if(isMobile()){
      // Сен 2020 → Июл 2021
      const y0a = posV(posRatio(PRE_START))*100;
      const y0b = posV(posRatio(FREEZE_START))*100;
      preLine.style.left = '44px'; preLine.style.width = '2px';
      preLine.style.top = `calc(${y0a}% )`;
      preLine.style.height = Math.max(0.5, y0b - y0a) + '%';
      preLine.style.transform = 'translateX(-50%)';

      // Июл 2021 → Ноя 2026
      const y1a = posV(posRatio(FREEZE_START))*100;
      const y1b = posV(posRatio(COURT_END))*100;
      baseLine.style.left = '44px'; baseLine.style.width = '4px';
      baseLine.style.top = `calc(${y1a}% )`;
      baseLine.style.height = Math.max(2, y1b - y1a) + '%';
      baseLine.style.transform = 'none';

      // Блокировка (красная) — слева
      const yf1 = posV(posRatio(FREEZE_START))*100;
      const yf2 = posV(posRatio(now))*100;
      freezeLine.style.left = `calc(44px - var(--freeze-offset))`;
      freezeLine.style.top = `calc(${Math.min(yf1,yf2)}% - 6px)`;
      freezeLine.style.height = Math.max(2, Math.abs(yf2 - yf1)) + '%';
      freezeLine.style.width = '12px';

      // Пунктир будущего
      const yfe1 = posV(posRatio(COURT_END))*100;
      const yfe2 = posV(posRatio(FUTURE_END))*100;
      futureLine.style.left = '44px';
      futureLine.style.top = `calc(${Math.min(yfe1,yfe2)}% )`;
      futureLine.style.height = Math.max(2, Math.abs(yfe2 - yfe1)) + '%';
      futureLine.style.width = '0';

      // «Сейчас» (горизонтально)
      nowEl.style.left = 0; nowEl.style.width = '100%'; nowEl.style.height = '3px';
      nowEl.style.top = (posV(posRatio(now))*100) + '%';
    } else {
      // Сен 2020 → Июл 2021
      const x0a = posH(posRatio(PRE_START))*100;
      const x0b = posH(posRatio(FREEZE_START))*100;
      preLine.style.left = x0a+'%';
      preLine.style.width = Math.max(0.5, x0b - x0a) + '%';

      // Июл 2021 → Ноя 2026
      const x1a = posH(posRatio(FREEZE_START))*100;
      const x1b = posH(posRatio(COURT_END))*100;
      baseLine.style.left = x1a+'%';
      baseLine.style.width = Math.max(2, x1b - x1a) + '%';

      // Блокировка → сейчас
      const xf1 = posH(posRatio(FREEZE_START))*100;
      const xf2 = posH(posRatio(new Date()))*100;
      freezeLine.style.left = Math.min(xf1, xf2) + '%';
      freezeLine.style.width = Math.max(2, Math.abs(xf2 - xf1)) + '%';

      // Пунктир будущего
      const xfe1 = posH(posRatio(COURT_END))*100;
      const xfe2 = posH(posRatio(FUTURE_END))*100;
      futureLine.style.left = Math.min(xfe1,xfe2) + '%';
      futureLine.style.width = Math.max(2, Math.abs(xfe2 - xfe1)) + '%';

      // «Сейчас» (вертикально)
      const xr = posH(posRatio(new Date()))*100;
      nowEl.style.left = xr+'%'; nowEl.style.top = 0; nowEl.style.bottom = 0;
      nowEl.style.width = '3px'; nowEl.style.height = '';
    }
  }

  /* ---------- кластеры (разрыв ≤ 60 дней) ---------- */
  const TWO_MONTHS = 1000*60*60*24*60;
  const pointItems = items.filter(it => !(it.date_start && it.date_end));
  const sorted = pointItems.slice().sort((a,b)=>{
    const ad = parseYM(a.date_start||a.date_end);
    const bd = parseYM(b.date_start||b.date_end);
    return ad - bd;
  });

  const clusters = [];
  let bucket = [];
  for (let i=0;i<sorted.length;i++){
    const cur = sorted[i];
    const curD = parseYM(cur.date_start||cur.date_end);
    if (bucket.length===0){ bucket.push(cur); continue; }
    const prevD = parseYM(bucket[bucket.length-1].date_start||bucket[bucket.length-1].date_end);
    if (curD - prevD <= TWO_MONTHS) bucket.push(cur);
    else { clusters.push(bucket); bucket=[cur]; }
  }
  if (bucket.length) clusters.push(bucket);

  /* ---------- точки и подписи ---------- */
  function fmtMonthYear(d){ return RU_MON[d.getUTCMonth()] + NBSP + d.getUTCFullYear(); }

  const dotRefs = []; // для пересчёта позиций на resize

  clusters.forEach(group=>{
    const firstD = parseYM(group[0].date_start||group[0].date_end);
    const lastD  = parseYM(group[group.length-1].date_start||group[group.length-1].date_end);
    const center = new Date((firstD.getTime()+lastD.getTime())/2);

    const dot = document.createElement('div'); dot.className='cluster-dot';
    const label = document.createElement('div'); label.className='label';

    // НОВОЕ: подсказка и доступность
    dot.setAttribute('title','Событие — нажмите для подробностей');
    dot.setAttribute('aria-label','Событие — нажмите для подробностей');
    dot.setAttribute('role','button');

    dot.dataset.center = +center;
    label.dataset.center = +center;

    function place(){
      if(isMobile()){
        const y = (posV(posRatio(center))*100);
        dot.style.top = `calc(${y}% - 8px)`; dot.style.left = '44px';
        label.style.left='60px'; label.style.top = dot.style.top;
      } else {
        const x = (posH(posRatio(center))*100) + '%';
        dot.style.left = x; dot.style.top = 'var(--lineY)';
        label.style.left = x; /* top управляется через CSS */
      }
    }
    place();

    if(group.length===1){
      label.textContent = group[0].when_label || '';
      dot.addEventListener('click', ()=> openModalSingle(group[0]));
    } else {
      label.textContent = `${fmtMonthYear(firstD)} – ${fmtMonthYear(lastD)}`;
      dot.addEventListener('click', ()=> openModalCluster(group));
    }

    track.appendChild(dot); track.appendChild(label);
    dotRefs.push({dot,label,center});
  });

  setLineSegments();

  /* ---------- resize без reload ---------- */
  let rszT;
  window.addEventListener('resize', ()=>{
    clearTimeout(rszT);
    rszT = setTimeout(()=>{
      setLineSegments();
      dotRefs.forEach(ref=>{
        const center = new Date(ref.center);
        if(isMobile()){
          const y = (posV(posRatio(center))*100);
          ref.dot.style.top = `calc(${y}% - 8px)`; ref.dot.style.left = '44px';
          ref.label.style.left='60px'; ref.label.style.top = ref.dot.style.top;
        } else {
          const x = (posH(posRatio(center))*100) + '%';
          ref.dot.style.left = x; ref.dot.style.top = 'var(--lineY)';
          ref.label.style.left = x;
        }
      });
    }, 120);
  });

  /* ---------- модалка (совместимо с сайтом) ---------- */
  const modal   = document.getElementById('modalBackdrop');
  const mTitle  = document.getElementById('modalTitle');
  const mBody   = document.getElementById('modalBody');
  const mClose  = document.getElementById('modalClose');

  function openModal(title, html){
    mTitle.innerHTML = title || '';
    mBody.innerHTML  = html  || '';
    modal.classList.add('show');
    document.body.classList.add('modal-open');
    modal.querySelector('.modal-dialog')?.focus();
  }
  function closeModal(){
    modal.classList.remove('show');
    document.body.classList.remove('modal-open');
  }
  mClose.addEventListener('click', closeModal);
  modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && modal.classList.contains('show')) closeModal(); });

  function openModalSingle(it){
    const more = it.details
      ? `<p><button class="btn js-more">Подробнее</button></p><div class="js-morebox" style="display:none">${esc(it.details)}</div>`
      : '';
    openModal(
      `${esc(it.when_label||'')} — ${esc(it.title||'')}`,
      `<div class="muted" style="margin-bottom:8px">${esc(it.summary||'')}</div>${more}`
    );
  }

  function openModalCluster(group){
    const list = group.map((it,i)=>`
      <div style="padding-top:10px; margin-top:10px; border-top:1px dashed rgba(255,255,255,.12)">
        <div style="font-weight:600">${esc(it.title||'')}</div>
        <div class="muted" style="margin:4px 0 6px 0">${esc(it.when_label||'')}</div>
        <div>${esc(it.summary||'')}</div>
        ${it.details?`<div class="js-morebox" style="display:none; margin-top:6px">${esc(it.details)}</div>
        <button class="btn js-more" style="margin-top:6px">Подробнее</button>`:''}
      </div>
    `).join('');
    openModal(`События (${group.length})`, list);
  }

  // НОВОЕ: делегирование на "Подробнее" — устойчиво к обоим вариантам разметки
  document.getElementById('modalBody').addEventListener('click', e=>{
    const btn = e.target.closest('.js-more');
    if(!btn) return;

    // ищем соседний .js-morebox (в кластере он до кнопки, в одиночном событии — после <p>)
    const findMoreBox = (button)=>{
      const isBox = el => el && el.classList && el.classList.contains('js-morebox');
      let el = button.previousElementSibling; if(isBox(el)) return el;
      el = button.nextElementSibling;         if(isBox(el)) return el;
      el = button.closest('p')?.nextElementSibling; if(isBox(el)) return el;
      return null;
    };

    const box = findMoreBox(btn);
    if(!box) return;

    const opened = box.style.display !== 'none';
    box.style.display = opened ? 'none' : 'block';
    btn.textContent = opened ? 'Подробнее' : 'Свернуть';
  });

})();
</script>
</body>
</html>
