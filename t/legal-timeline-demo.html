<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Legal Timeline Demo — TRUS</title>

<!-- Актуальные стили проекта (как в D-Story) -->
<link rel="stylesheet" href="https://therealunrealstory.com/assets/styles.css" />

<style>
:root{
  /* Палитра */
  --indigo-300:#a5b4fc;      /* светлая линия (до суда) */
  --indigo-600:#4f46e5;      /* основная линия (период суда) и пунктир будущего */
  --red-500:#ef4444;         /* линия блокировки */
  --muted: rgba(231,236,243,.7);

  /* Геометрия и отступы */
  --tl-gutter-h:6%;          /* равные отступы слева/справа */
  --tl-gutter-v:8%;          /* вертикальные отступы (моб.) */
  --lineY:62%;               /* опустить линии вниз контейнера */
  --freeze-offset:16px;      /* смещение толстой линии относительно базовой */
}

/* Контейнер демо */
body{margin:0; color:#e7ecf3; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
.wrap{ max-width:1100px; margin:28px auto; padding:0 16px; }
.roadmap-head{ background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:16px 18px; margin-bottom:16px; }
.roadmap-title{ margin:0 0 6px 0; font-size:22px; }
.roadmap-meta{ color:var(--muted); font-size:14px; }

.timeline{
  position:relative; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:16px;
  overflow:hidden; width: min(1400px, calc(100vw - 32px));
  margin-left: max(16px, calc(50% - 50vw + 16px));
  margin-right: max(16px, calc(50% - 50vw + 16px));
}
.track{ position:relative; width:100%; height:360px; }

/* ── ЛИНИИ ───────────────────────────────────────────────────────── */
.base-line{                 /* 1) тонкая общая индиго 600: Сен 2020 → Ноя 2026 */
  position:absolute; height:4px; background:var(--indigo-600);
  left:var(--tl-gutter-h); right:var(--tl-gutter-h);
  top:var(--lineY); transform:translateY(-50%); z-index:2;
}
.pre-cause-line{            /* 0) светлая индиго: Сен 2020 → Июл 2021 */
  position:absolute; height:2px; background:var(--indigo-300);
  top:calc(var(--lineY) - 1px); z-index:3; border-radius:2px;
}
.freeze-line{               /* 3) красная толстая: Июл 2021 → Сейчас */
  position:absolute; height:12px; background:var(--red-500); border-radius:8px;
  top: calc(var(--lineY) + var(--freeze-offset)); z-index:3;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
}
.future-line{               /* 4) пунктир индиго 600: Ноя 2026 → будущее */
  position:absolute; height:4px; background:transparent;
  top:var(--lineY); transform:translateY(-50%); z-index:2;
  border-top:4px dashed var(--indigo-600);
}

/* точки/кластеры — один аккуратный стиль */
.cluster-dot{
  position:absolute; width:16px; height:16px; border-radius:50%;
  background:#ffffff; outline:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 0 2px rgba(79,70,229,.45); /* ореол индиго */
  cursor:pointer; transform:translate(-50%,-50%); z-index:4;
}

/* подписи дат */
.label{ position:absolute; font-size:12px; color:var(--muted); white-space:nowrap; text-shadow:0 1px 0 rgba(0,0,0,.35); }
@media (min-width: 821px){
  .label{ transform: translate(-50%, -140%) rotate(180deg); writing-mode: vertical-rl; text-orientation: mixed; }
}

/* Маркер «Сейчас» */
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(165,180,252,.6);}70%{box-shadow:0 0 0 12px rgba(165,180,252,0);}100%{box-shadow:0 0 0 0 rgba(165,180,252,0);} }
.now-marker{ position:absolute; background:#a5b4fc; border-radius:2px; animation:pulse 1.9s ease-out infinite; z-index:5; }

/* Подсказка */
.hint{ padding:10px 12px; color:var(--muted); font-size:13px; border-top:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.05); }

/* ── Мобильная вертикальная версия ──────────────────────────────── */
@media (max-width:820px){
  .track{ height:1200px; }
  .base-line{
    left:44px; width:4px; height:calc(100% - 44px); top:auto; bottom:auto; transform:none;
    top: calc(var(--tl-gutter-v)); bottom: calc(var(--tl-gutter-v));
  }
  .pre-cause-line{ left:44px; width:2px; top:auto; transform:none; }
  .freeze-line{ left: calc(44px + var(--freeze-offset)); width:12px; height:auto; top:auto; }
  .future-line{
    left:44px; width:0; height:auto; border-top:none; border-left:4px dashed var(--indigo-600);
    transform:none;
  }
  .cluster-dot{ left:44px; transform:translate(-50%,0); }
  .label{ left:60px; transform:none; }
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="roadmap-head">
      <h1 class="roadmap-title">Юридическая хронология (демо)</h1>
      <div class="roadmap-meta" id="meta">Загрузка…</div>
    </div>
  </div>

  <div class="timeline">
    <div class="track" id="track">
      <div class="base-line" id="baseLine"></div>
      <div class="pre-cause-line" id="preLine"></div>
      <div class="freeze-line" id="freezeLine"></div>
      <div class="future-line" id="futureLine"></div>
      <div class="now-marker" id="now"></div>
    </div>
    <div class="hint">Линии: светло‑индиго — предпосылки; индиго — период суда; красная — период блокировки; пунктир — судебные перспективы (неопределённо).</div>
  </div>

  <!-- Модалка (как в D‑Story): используем только .modal-backdrop/.show -->
  <div class="modal-backdrop" id="modalBack" aria-modal="true" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-dialog" role="document">
      <h2 id="modalTitle"></h2>
      <div id="mWhen" class="muted"></div>
      <div id="mSummary"></div>
      <div id="mDetails" style="display:none"></div>
      <div id="mList" style="display:none"></div>
      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="toggleDetails">Подробнее</button>
        <button class="btn" id="closeModal" style="margin-left:auto;">Закрыть</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  const res = await fetch('./legal-timeline.json', {cache:'no-store'});
  if(!res.ok){ document.getElementById('meta').textContent = 'Не удалось загрузить legal-timeline.json'; return; }
  const data = await res.json();

  const parseYM = s=>{
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00Z');
    if(/^\d{4}-\d{2}$/.test(s)) return new Date(s+'-01T00:00:00Z');
    if(/^\d{4}$/.test(s)) return new Date(s+'-01-01T00:00:00Z');
    return new Date(s);
  };
  const esc = s => String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const NBSP = '\u00A0';
  const RU_MON = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
  const isMobile = () => matchMedia('(max-width:820px)').matches;

  const items = (data.items||[]).slice().sort((a,b)=>{
    const ad = parseYM(a.date_start||a.date_end);
    const bd = parseYM(b.date_start||b.date_end);
    return ad - bd;
  });

  document.getElementById('meta').textContent =
    `Обновлено: ${new Date(data.meta.updated_at).toLocaleString()} • ${data.meta.updated_by} • версия: ${data.meta.version}`;

  /* === ДАТЫ-ОПОРЫ ДЛЯ РАВНЫХ ОТСТУПОВ ПО КРАЙНИМ ЛИНИЯМ === */
  const PRE_START = parseYM('2020-09-01'); // начало светлой линии
  const FREEZE_START = parseYM('2021-07-01'); // старт блокировки + старт «судебного периода»
  const COURT_END = parseYM('2026-11-01'); // Ноя 2026
  const FUTURE_MONTHS = 6;                 // длина пунктирной будущей линии (короткая)
  const FUTURE_END = new Date(COURT_END);  FUTURE_END.setUTCMonth(FUTURE_END.getUTCMonth()+FUTURE_MONTHS);

  // шкала теперь маппится: PRE_START → левый гуттер, FUTURE_END → правый гуттер
  const GUTTER_H = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tl-gutter-h'))/100 || 0.06;
  const GUTTER_V = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tl-gutter-v'))/100 || 0.08;

  const domainStart = PRE_START;
  const domainEnd = FUTURE_END;
  const spanMs = domainEnd - domainStart;

  function posRatio(d){ return clamp((d - domainStart) / spanMs, 0, 1); }
  const posH = r => GUTTER_H + r * (1 - GUTTER_H*2);
  const posV = r => GUTTER_V + r * (1 - GUTTER_V*2);

  /* === ЛИНИИ === */
  const baseLine = document.getElementById('baseLine');
  const preLine = document.getElementById('preLine');
  const freezeLine = document.getElementById('freezeLine');
  const futureLine = document.getElementById('futureLine');
  const nowEl = document.getElementById('now');
  const track = document.getElementById('track');

  function setLineSegments(){
    const now = new Date();

    if(isMobile()){
      // Вертикальная база (Сен 2020 → Ноя 2026)
      const y1 = posV( posRatio(PRE_START) )*100;
      const y2 = posV( posRatio(COURT_END) )*100;
      baseLine.style.left = '44px'; baseLine.style.width = '4px';
      baseLine.style.top = `calc(${y1}% )`;
      baseLine.style.height = Math.max(2, y2 - y1) + '%';

      // Светлая (Сен 2020 → Июл 2021)
      const yp1 = posV( posRatio(PRE_START) )*100;
      const yp2 = posV( posRatio(FREEZE_START) )*100;
      preLine.style.left = '44px'; preLine.style.width = '2px';
      preLine.style.top = `calc(${yp1}% )`;
      preLine.style.height = Math.max(0.5, yp2 - yp1) + '%';
      preLine.style.transform = 'translateX(-50%)';

      // Красная (Июл 2021 → Сейчас), параллельно
      const yf1 = posV( posRatio(FREEZE_START) )*100;
      const yf2 = posV( posRatio(now) )*100;
      freezeLine.style.left = `calc(44px + var(--freeze-offset))`;
      freezeLine.style.top = `calc(${Math.min(yf1,yf2)}% - 6px)`;
      freezeLine.style.height = Math.max(2, Math.abs(yf2 - yf1)) + '%';
      freezeLine.style.width = '12px';

      // Пунктир (Ноя 2026 → FUTURE_END), параллельно базе
      const yfe1 = posV( posRatio(COURT_END) )*100;
      const yfe2 = posV( posRatio(FUTURE_END) )*100;
      futureLine.style.left = '44px';
      futureLine.style.top = `calc(${Math.min(yfe1,yfe2)}% )`;
      futureLine.style.height = Math.max(2, Math.abs(yfe2 - yfe1)) + '%';
      futureLine.style.width = '0';

      // «Сейчас» — горизонтальная полоска на уровне now
      nowEl.style.left = 0; nowEl.style.width = '100%'; nowEl.style.height = '3px';
      nowEl.style.top = (posV(posRatio(now))*100) + '%';
    } else {
      // Горизонтальная база (Сен 2020 → Ноя 2026)
      const x1 = posH( posRatio(PRE_START) )*100;
      const x2 = posH( posRatio(COURT_END) )*100;
      baseLine.style.left = x1+'%';
      baseLine.style.right = (100 - x2)+'%';

      // Светлая (Сен 2020 → Июл 2021) над базовой
      const xp1 = posH( posRatio(PRE_START) )*100;
      const xp2 = posH( posRatio(FREEZE_START) )*100;
      preLine.style.left = xp1+'%';
      preLine.style.width = Math.max(0.5, xp2 - xp1) + '%';

      // Красная (Июл 2021 → Сейчас), параллельно ниже
      const xf1 = posH( posRatio(FREEZE_START) )*100;
      const xf2 = posH( posRatio(new Date()) )*100;
      freezeLine.style.left = Math.min(xf1, xf2) + '%';
      freezeLine.style.width = Math.max(2, Math.abs(xf2 - xf1)) + '%';

      // Пунктир (Ноя 2026 → FUTURE_END)
      const xfe1 = posH( posRatio(COURT_END) )*100;
      const xfe2 = posH( posRatio(FUTURE_END) )*100;
      futureLine.style.left = Math.min(xfe1,xfe2) + '%';
      futureLine.style.width = Math.max(2, Math.abs(xfe2 - xfe1)) + '%';

      // «Сейчас» — вертикальная полоска в своей позиции
      const xr = posH( posRatio(new Date()) )*100;
      nowEl.style.left = xr+'%'; nowEl.style.top = 0; nowEl.style.bottom = 0;
      nowEl.style.width = '3px'; nowEl.style.height = '';
    }
  }

  /* === КЛАСТЕРЫ (≤ 2 мес) и точки/подписи === */
  const TWO_MONTHS = 1000*60*60*24*60;
  const pointItems = items.filter(it => !(it.date_start && it.date_end));
  const clusters = [];
  for(const it of pointItems){
    const d = parseYM(it.date_start || it.date_end);
    let c = clusters.find(x => Math.abs(x.center - d) <= TWO_MONTHS);
    if(!c){ c = { center:d, items:[] }; clusters.push(c); }
    else c.center = new Date((c.center.getTime()*c.items.length + d.getTime())/(c.items.length+1));
    c.items.push(it);
  }
  clusters.sort((a,b)=>a.center - b.center);

  clusters.forEach(c=>{
    const dot = document.createElement('div'); dot.className='cluster-dot';
    const label = document.createElement('div'); label.className='label';

    if(isMobile()){
      const y = (posV(posRatio(c.center))*100);
      dot.style.top = `calc(${y}% - 8px)`; dot.style.left = '44px';
      label.style.left='60px'; label.style.top = dot.style.top;
    } else {
      const x = (posH(posRatio(c.center))*100);
      dot.style.left = x+'%'; dot.style.top = 'var(--lineY)';
      label.style.left = dot.style.left; label.style.top = 'var(--lineY)';
    }

    if(c.items.length===1){
      label.textContent = c.items[0].when_label || '';
      dot.addEventListener('click', ()=> openModalSingle(c.items[0]));
    } else {
      const ds = c.items.map(i=>parseYM(i.date_start||i.date_end)).sort((a,b)=>a-b);
      const fmt = d => RU_MON[d.getUTCMonth()] + NBSP + d.getUTCFullYear();
      label.textContent = `${fmt(ds[0])} – ${fmt(ds[ds.length-1])}`;
      dot.addEventListener('click', ()=> openModalCluster(c.items));
    }

    track.appendChild(dot); track.appendChild(label);
  });

  setLineSegments();
  addFutureCaption();
  window.addEventListener('resize', ()=> location.reload());

  /* === Подпись к пунктирной линии («будущее») === */
  function addFutureCaption(){
    const cap = document.createElement('div');
    cap.className = 'label';
    cap.textContent = 'Дальнейшее судебное разбирательство (период не определён)';
    if(isMobile()){
      const y = (posV(posRatio(COURT_END + 1))*100); // рядом с началом пунктира
      cap.style.left = '60px'; cap.style.top = `calc(${y}% - 8px)`;
    } else {
      const x = (posH(posRatio(COURT_END))*100);
      cap.style.left = (x + 2) + '%'; cap.style.top = 'var(--lineY)';
    }
    track.appendChild(cap);
  }

  /* === МОДАЛКИ (как в D‑Story: .modal-backdrop/.show) === */
  const back = document.getElementById('modalBack');
  const tTitle = document.getElementById('modalTitle');
  const tWhen = document.getElementById('mWhen');
  const tSummary = document.getElementById('mSummary');
  const tDetails = document.getElementById('mDetails');
  const tList = document.getElementById('mList');
  const btnToggle = document.getElementById('toggleDetails');
  const btnClose = document.getElementById('closeModal');

  function openBackdrop(){ back.classList.add('show'); }
  function closeBackdrop(){ back.classList.remove('show'); }

  function openModalSingle(it){
    tList.style.display='none'; tList.innerHTML='';
    tTitle.textContent = it.title || '';
    tWhen.textContent = it.when_label || '';
    tSummary.innerHTML = esc(it.summary || '');
    tDetails.innerHTML = esc(it.details || '');
    tDetails.style.display = it.details ? 'none' : 'none';
    btnToggle.style.display = it.details ? '' : 'none';
    openBackdrop();
  }
  function openModalCluster(items){
    const sorted = items.slice().sort((a,b)=>{
      const ad = parseYM(a.date_start||a.date_end), bd = parseYM(b.date_start||b.date_end);
      return ad - bd;
    });
    tTitle.textContent = `События (${sorted.length})`;
    tWhen.textContent = '';
    tSummary.textContent = 'Сгруппированные по времени события.';
    tDetails.style.display='none'; tDetails.innerHTML='';
    btnToggle.style.display='none';
    tList.innerHTML = sorted.map((it,idx)=>`
      <div style="padding-top:10px; margin-top:10px; border-top:1px dashed rgba(255,255,255,.12)">
        <div style="font-weight:600">${esc(it.title||'')}</div>
        <div class="muted" style="margin:4px 0 6px 0">${esc(it.when_label||'')}</div>
        <div>${esc(it.summary||'')}</div>
        ${it.details?`<div id="d-${idx}" style="display:none; margin-top:6px">${esc(it.details)}</div>
        <button class="btn btn-more" data-i="${idx}" style="margin-top:6px">Подробнее</button>`:''}
      </div>
    `).join('');
    tList.style.display='block';
    openBackdrop();
  }

  document.addEventListener('click', e=>{
    const btn = e.target.closest('.btn-more');
    if(!btn) return;
    const id = 'd-'+btn.getAttribute('data-i');
    const el = document.getElementById(id);
    const vis = el.style.display==='block';
    el.style.display = vis?'none':'block';
    btn.textContent = vis?'Подробнее':'Свернуть';
  });

  btnToggle.addEventListener('click', ()=>{
    const vis = tDetails.style.display==='block';
    tDetails.style.display = vis ? 'none' : 'block';
    btnToggle.textContent = vis ? 'Подробнее' : 'Свернуть';
  });
  btnClose.addEventListener('click', closeBackdrop);
  back.addEventListener('click', (e)=>{ if(e.target === back) closeBackdrop(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeBackdrop(); });

})();
</script>
</body>
</html>
