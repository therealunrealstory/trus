<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Legal Timeline Demo — Indigo + Pulse + Clusters</title>
<style>
  :root{
    --bg: #0b0f18;
    --panel: rgba(255,255,255,0.05);
    --panel-2: rgba(255,255,255,0.08);
    --text: #e7ecf3;
    --muted: #a9b4c0;
    --border: rgba(255,255,255,0.12);
    --indigo: #6366f1;  /* основная линия таймлайна */
    --now: #a5b4fc;     /* индиго-светлый для «Now» */

    /* Роли (как договорились) */
    --role-plaintiff: #f59e0b;
    --role-defendant: #3b82f6;
    --role-court:     #a78bfa;
    --role-admin:     #10b981;

    /* Статусы (интенсивность) */
    --alpha-done: 1;
    --alpha-current: 1;
    --alpha-planned: .55;
    --alpha-tentative: .4;

    --radius: 14px;
    --shadow: 0 8px 30px rgba(0,0,0,.35);
  }

  @keyframes pulseGlow {
    0%   { box-shadow: 0 0 0 0 rgba(165,180,252, .60); }
    70%  { box-shadow: 0 0 0 10px rgba(165,180,252, .0); }
    100% { box-shadow: 0 0 0 0 rgba(165,180,252, .0); }
  }

  html,body{height:100%;}
  body{
    margin:0; background:linear-gradient(180deg,#0b0f18,#0a1122);
    color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  }

  .wrap{ max-width:1100px; margin:28px auto; padding:0 16px; }

  .head{
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px 18px; box-shadow:var(--shadow);
    margin-bottom:16px;
  }
  .head h1{ margin:0 0 6px 0; font-size:22px; }
  .meta{ color:var(--muted); font-size:14px; }

  .timeline{
    position:relative; background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
  }

  .track-scroll{ position:relative; overflow:auto; -webkit-overflow-scrolling:touch; }

  .track{ position:relative; min-height:240px; min-width:900px; }

  /* Базовая линия — ИНДИГО */
  .line{
    position:absolute; left:0; right:0; top:50%; height:4px; background:var(--indigo);
    opacity:.65; transform:translateY(-50%);
  }

  /* Вертикальная версия (мобайл) */
  @media (max-width: 820px){
    .track{ min-height:900px; min-width:100%; }
    .line{ left:40px; width:4px; height:calc(100% - 40px); top:20px; bottom:20px; transform:none; }
  }

  /* NOW — пульсирующая линия */
  .now-marker{
    position:absolute; top:0; bottom:0; width:3px; background:var(--now);
    animation: pulseGlow 1.9s ease-out infinite;
    border-radius:2px;
  }
  @media (max-width: 820px){
    .now-marker{ left:0; top:0; width:100%; height:3px; animation: pulseGlow 1.9s ease-out infinite; }
  }

  /* Сегменты (периоды) */
  .segment{
    position:absolute; height:10px; border-radius:6px;
    background:var(--role-admin);
    opacity:var(--alpha-current);
    filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
  }
  .segment.planned{ opacity:var(--alpha-planned); }
  .segment.tentative{ opacity:var(--alpha-tentative); }
  .segment.done{ opacity:var(--alpha-done); }
  .segment.role-plaintiff{ background:var(--role-plaintiff); }
  .segment.role-defendant{ background:var(--role-defendant); }
  .segment.role-court{ background:var(--role-court); }
  .segment.role-admin{ background:var(--role-admin); }

  /* Точки событий / кластеры */
  .dot, .cluster-dot{
    position:absolute; width:16px; height:16px; border-radius:50%;
    box-shadow:0 0 0 2px rgba(0,0,0,.25);
    outline:1px solid var(--border);
    cursor:pointer; transform:translate(-50%, -50%);
  }
  .dot.role-plaintiff, .cluster-dot.role-plaintiff{ background:var(--role-plaintiff); }
  .dot.role-defendant, .cluster-dot.role-defendant{ background:var(--role-defendant); }
  .dot.role-court, .cluster-dot.role-court{ background:var(--role-court); }
  .dot.role-admin, .cluster-dot.role-admin{ background:var(--role-admin); }
  .dot.status-planned, .cluster-dot.status-planned{ opacity:var(--alpha-planned); outline-style:dashed; }
  .dot.status-tentative, .cluster-dot.status-tentative{ opacity:var(--alpha-tentative); outline-style:dashed; }

  /* Бейдж количества в кластере */
  .cluster-badge{
    position:absolute; right:-8px; top:-8px; min-width:18px; height:18px;
    background:#0f172a; color:#c7d2fe; border:1px solid var(--border);
    border-radius:10px; padding:0 5px; font-size:11px; display:flex; align-items:center; justify-content:center;
  }

  @media (max-width: 820px){
    .dot, .cluster-dot{ left:40px; transform:translate(-50%, 0); }
    .segment{ left:40px; transform:translateX(-50%); width:8px; }
  }

  /* Подписи дат */
  .label{
    position:absolute; transform:translate(-50%, 10px);
    font-size:12px; color:var(--muted); white-space:nowrap;
    text-shadow:0 1px 0 rgba(0,0,0,.35);
  }
  @media (max-width: 820px){
    .label{ left:56px; transform:none; }
  }

  /* Карточка */
  .card{
    position:absolute; min-width:280px; max-width:420px;
    background:#0f1624; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    padding:12px 14px; z-index:20; display:none;
  }
  .card h3{ margin:0 0 4px 0; font-size:16px; }
  .card .when{ color:var(--muted); font-size:13px; margin-bottom:6px; }
  .card .summary{ font-size:14px; margin-bottom:8px; color:#d9e2ee; }
  .card .details{ font-size:14px; color:#c8d3e0; display:none; }
  .card .actions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
  .btn{
    background:var(--panel-2); color:var(--text); border:1px solid var(--border);
    border-radius:9px; padding:6px 10px; font-size:13px; cursor:pointer;
  }
  .btn:hover{ filter:brightness(1.1); }

  .hint{
    padding:10px 12px; color:var(--muted); font-size:13px;
    border-top:1px solid var(--border); background:var(--panel);
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1>Юридическая хронология (демо)</h1>
      <div class="meta" id="meta">Загрузка…</div>
    </div>

    <div class="timeline">
      <div class="track-scroll" id="scroll">
        <div class="track" id="track">
          <div class="line"></div>
          <div class="now-marker" id="now"></div>
          <!-- элементы рендерятся скриптом -->
        </div>
      </div>
      <div class="hint">Подсказка: на десктопе прокручивайте колёсиком (или Shift+колёсико) по горизонтали; нажимайте на точки, чтобы раскрывать детали.</div>
    </div>
  </div>

<script>
(async function(){
  const res = await fetch('./legal-timeline.json', {cache:'no-store'});
  if(!res.ok){ document.getElementById('meta').textContent = 'Не удалось загрузить legal-timeline.json'; return; }
  const data = await res.json();

  /* ===== Utilities ===== */
  const parseYM = s=>{
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00Z');
    if(/^\d{4}-\d{2}$/.test(s)) return new Date(s+'-01T00:00:00Z');
    if(/^\d{4}$/.test(s)) return new Date(s+'-01-01T00:00:00Z');
    return new Date(s);
  };
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const escapeHtml = s => String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  /* ===== Time domain ===== */
  const items = data.items.slice().sort((a,b)=>{
    const ad = parseYM(a.date_start||a.date_end);
    const bd = parseYM(b.date_start||b.date_end);
    return ad - bd;
  });

  const firstDate = parseYM(items[0].date_start || items[0].date_end);
  const lastRef   = items.reduce((d,it)=> {
    const p = parseYM(it.date_end || it.date_start);
    return p>d ? p : d;
  }, firstDate);

  const today = new Date();
  const domainStart = firstDate;
  const domainEnd = new Date(Math.max(today.getTime(), lastRef.getTime()));
  const spanMs = domainEnd - domainStart;

  const fmtMeta = (iso)=> new Date(iso).toLocaleString();
  document.getElementById('meta').textContent =
    `Обновлено: ${fmtMeta(data.meta.updated_at)} • ${data.meta.updated_by} • версия: ${data.meta.version}`;

  /* Layout refs */
  const track = document.getElementById('track');
  const scroll = document.getElementById('scroll');
  const nowEl = document.getElementById('now');
  const isMobile = () => window.matchMedia('(max-width: 820px)').matches;

  function posRatio(d){
    if(!d) return 0;
    return clamp((d - domainStart) / spanMs, 0, 1);
  }

  function placeNow(){
    const r = posRatio(today);
    if(isMobile()){
      // На мобиле "Now" — горизонтальная линия вверху, пульс анимирован
      nowEl.style.left = '0'; nowEl.style.top = '0';
      nowEl.style.right = '0'; nowEl.style.bottom = '';
      nowEl.style.height = '3px'; nowEl.style.width = '';
    } else {
      nowEl.style.left = (r*100)+'%';
      nowEl.style.top = '0'; nowEl.style.bottom = '0';
      nowEl.style.width = '3px'; nowEl.style.height = '';
    }
  }

  function roleClass(role){ return 'role-' + (role||'admin'); }
  function statusClass(st){ return 'status-' + (st||'done'); }

  /* ===== Render segments (periods) ===== */
  function renderSegment(it){
    const start = parseYM(it.date_start);
    const end = it.date_end ? parseYM(it.date_end) : null;
    const isPeriod = !!(start && end) || (!!start && it.type==='freeze' && it.status!=='done');
    if(!isPeriod) return;

    const seg = document.createElement('div');
    seg.className = `segment ${roleClass(it.role)} ${statusClass(it.status)}`;
    if(isMobile()){
      const y1 = posRatio(start)*100;
      const y2 = posRatio(end || domainEnd)*100;
      const len = Math.max(2, y2 - y1);
      seg.style.top = `calc(${y1}% - 5px)`;
      seg.style.height = len+'%';
    } else {
      const x1 = posRatio(start)*100;
      const x2 = posRatio(end || domainEnd)*100;
      const len = Math.max(2, x2 - x1);
      seg.style.left = x1+'%';
      seg.style.top = 'calc(50% - 5px)';
      seg.style.width = len+'%';
    }
    seg.dataset.id = it.id;
    seg.title = (it.title||'') + (it.when_label?(' — '+it.when_label):'');
    seg.addEventListener('click', (e)=> openCard(it, e.currentTarget));
    track.appendChild(seg);
  }

  /* ===== Clustering points within ~2 months ===== */
  const TWO_MONTHS_MS = 1000 * 60 * 60 * 24 * 60; // ~60 дней
  const pointEvents = items.filter(it=>{
    const start = parseYM(it.date_start || it.date_end);
    const end = it.date_end ? parseYM(it.date_end) : null;
    const isPeriod = !!(start && end) || (!!start && it.type==='freeze' && it.status!=='done');
    return !isPeriod;
  });

  // Группируем близкие точки
  const clusters = [];
  for(const it of pointEvents){
    const d = parseYM(it.date_start || it.date_end);
    let cluster = clusters.find(c => Math.abs(c.center - d) <= TWO_MONTHS_MS);
    if(!cluster){
      cluster = { center: d, items: [] };
      clusters.push(cluster);
    } else {
      // подвинем центр к среднему для устойчивости
      cluster.center = new Date( (cluster.center.getTime()*cluster.items.length + d.getTime()) / (cluster.items.length+1) );
    }
    cluster.items.push(it);
  }

  // выбираем доминирующую роль/статус для отображения кластера
  function dominantRole(its){
    // приоритет court > plaintiff > defendant > admin (чтобы заседания виднее)
    const pr = { court:3, plaintiff:2, defendant:1, admin:0 };
    return its.slice().sort((a,b)=>(pr[b.role||'admin'] - pr[a.role||'admin']))[0].role || 'admin';
  }
  function dominantStatus(its){
    const pr = { current:3, done:2, planned:1, tentative:0 };
    return its.slice().sort((a,b)=>(pr[(b.status||'done')] - pr[(a.status||'done')]))[0].status || 'done';
  }

  /* ===== Render all ===== */
  // 1) Segments first
  items.forEach(renderSegment);

  // 2) Render cluster dots (or single-dot clusters)
  clusters.forEach(cluster=>{
    const role = dominantRole(cluster.items);
    const status = dominantStatus(cluster.items);

    const dot = document.createElement('div');
    dot.className = `cluster-dot ${roleClass(role)} ${statusClass(status)}`;

    if(isMobile()){
      const y = posRatio(cluster.center)*100;
      dot.style.top = `calc(${y}% - 8px)`;
    } else {
      const x = posRatio(cluster.center)*100;
      dot.style.left = x+'%';
      dot.style.top = '50%';
    }

    // метка даты (если кластер из 1 — берём его when_label; если больше — диапазон)
    const label = document.createElement('div');
    label.className = 'label';
    if(cluster.items.length === 1){
      label.textContent = cluster.items[0].when_label || '';
    } else {
      // формируем краткий диапазон дат на основе min/max
      const mind = cluster.items.map(i=>parseYM(i.date_start || i.date_end)).reduce((a,b)=>a<b?a:b);
      const maxd = cluster.items.map(i=>parseYM(i.date_start || i.date_end)).reduce((a,b)=>a>b?a:b);
      const fmt = d => d.toLocaleDateString(undefined, {year:'numeric', month:'short'});
      label.textContent = `${fmt(mind)} – ${fmt(maxd)}`;
    }
    if(isMobile()){
      label.style.top = dot.style.top;
      label.style.left = '56px';
    } else {
      label.style.left = dot.style.left;
      label.style.top = 'calc(50% + 12px)';
    }

    // бейдж количества, если > 1
    if(cluster.items.length > 1){
      const badge = document.createElement('div');
      badge.className = 'cluster-badge';
      badge.textContent = cluster.items.length;
      dot.appendChild(badge);
    }

    dot.addEventListener('click', (e)=> openClusterCard(cluster, e.currentTarget));
    track.appendChild(dot);
    track.appendChild(label);
  });

  placeNow();
  window.addEventListener('resize', ()=> location.reload());

  /* ===== Cards ===== */
  function makeCardHTML(item){
    return `
      <h3>${escapeHtml(item.title||'')}</h3>
      <div class="when">${escapeHtml(item.when_label||'')}</div>
      <div class="summary">${escapeHtml(item.summary||'')}</div>
      <div class="details">${escapeHtml(item.details||'')}</div>
      <div class="actions">
        <button class="btn btn-more">Подробнее</button>
        <button class="btn btn-close">Закрыть</button>
      </div>
    `;
  }

  function openCard(item, anchor){
    closeCards();
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = makeCardHTML(item);
    track.appendChild(card);
    positionCard(card, anchor);
    wireCard(card);
  }

  function openClusterCard(cluster, anchor){
    closeCards();
    const card = document.createElement('div');
    card.className = 'card';

    // внутри — список событий кластера; каждое — своя секция с кнопкой «Подробнее»
    const sorted = cluster.items.slice().sort((a,b)=>{
      const ad = parseYM(a.date_start||a.date_end);
      const bd = parseYM(b.date_start||b.date_end);
      return ad - bd;
    });

    card.innerHTML = `
      <h3>События (${sorted.length})</h3>
      <div class="when"></div>
      <div class="summary">В этом периоде сгруппированы близкие события.</div>
      <div class="details" style="display:block;">
        ${sorted.map(it => `
          <div style="border-top:1px dashed var(--border); padding-top:8px; margin-top:8px;">
            <div style="font-weight:600; margin-bottom:2px;">${escapeHtml(it.title||'')}</div>
            <div style="color:var(--muted); font-size:13px; margin-bottom:4px;">${escapeHtml(it.when_label||'')}</div>
            <div style="margin-bottom:6px;">${escapeHtml(it.summary||'')}</div>
            <details>
              <summary class="btn" style="display:inline-block; list-style:none; cursor:pointer;">Подробнее</summary>
              <div style="margin-top:8px;">${escapeHtml(it.details||'')}</div>
            </details>
          </div>
        `).join('')}
      </div>
      <div class="actions">
        <button class="btn btn-close">Закрыть</button>
      </div>
    `;
    track.appendChild(card);
    positionCard(card, anchor);
    wireCard(card, { noMoreToggle:true });
  }

  function positionCard(card, anchor){
    const rect = anchor.getBoundingClientRect();
    const srect = track.getBoundingClientRect();
    if(isMobile()){
      card.style.left = '72px';
      card.style.top = `calc(${anchor.style.top || '0px'} + 10px)`;
    } else {
      const left = rect.left - srect.left;
      card.style.left = Math.min(Math.max(left - 150, 8), srect.width - 440) + 'px';
      card.style.top = (srect.height/2 + 18) + 'px';
    }
    card.style.display = 'block';
  }

  function wireCard(card, opts={}){
    const btnMore = card.querySelector('.btn-more');
    const btnClose = card.querySelector('.btn-close');
    const details = card.querySelector('.details');
    if(btnMore && !opts.noMoreToggle){
      btnMore.addEventListener('click', ()=>{
        const vis = details.style.display === 'block';
        details.style.display = vis ? 'none' : 'block';
        btnMore.textContent = vis ? 'Подробнее' : 'Свернуть';
      });
    }
    if(btnClose){
      btnClose.addEventListener('click', ()=> card.remove());
    }
  }

  function closeCards(){
    track.querySelectorAll('.card').forEach(n=>n.remove());
  }

  /* Горизонтальный скролл на десктопе */
  if(!isMobile()){
    scroll.addEventListener('wheel', (e)=>{
      if(e.shiftKey || Math.abs(e.deltaX) > Math.abs(e.deltaY)){
        scroll.scrollLeft += e.deltaY + e.deltaX;
        e.preventDefault();
      }
    }, {passive:false});
  }
})();
</script>
</body>
</html>
