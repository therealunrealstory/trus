<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Legal Timeline Demo — TRUS</title>

<link rel="stylesheet" href="https://therealunrealstory.com/assets/styles.css" />

<style>
:root{
  --trus-bg:#0b0f18;
  --trus-panel:rgba(255,255,255,0.05);
  --trus-panel-2:rgba(255,255,255,0.08);
  --trus-text:#e7ecf3; --trus-muted:#a9b4c0; --trus-border:rgba(255,255,255,0.12);

  --indigo-300:#a5b4fc; --indigo-600:#4f46e5;  /* базовая линия */
  --freeze:#f59e0b; /* Amber 500 — линия блокировки (контрастна и в палитре сайта) */

  --now-color: var(--indigo-300);
  --dot-color: var(--indigo-300);
  --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.35);

  /* отступы шкалы */
  --tl-gutter-h:6%;
  --tl-gutter-v:8%;

  /* вертикальная позиция базовой линии (ниже середины) */
  --lineY: 62%;
  /* смещение толстой линии относительно базовой */
  --freeze-offset: 16px;
}

@keyframes trusPulse{0%{box-shadow:0 0 0 0 rgba(165,180,252,.6);}70%{box-shadow:0 0 0 12px rgba(165,180,252,0);}100%{box-shadow:0 0 0 0 rgba(165,180,252,0);} }

html,body{height:100%}
body{margin:0; background:linear-gradient(180deg, var(--trus-bg), #0a1122); color:var(--trus-text);
  font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

.wrap{ max-width:1100px; margin:28px auto; padding:0 16px; }
.roadmap-head{ background:var(--trus-panel); border:1px solid var(--trus-border); border-radius:var(--radius); padding:16px 18px; box-shadow:var(--shadow); margin-bottom:16px; }
.roadmap-title{ margin:0 0 6px 0; font-size:22px; }
.roadmap-meta{ color:var(--trus-muted); font-size:14px; }

.timeline{
  position:relative; background:var(--trus-panel); border:1px solid var(--trus-border); border-radius:var(--radius);
  box-shadow:var(--shadow); overflow:hidden;
  width: min(1400px, calc(100vw - 32px));
  margin-left: max(16px, calc(50% - 50vw + 16px));
  margin-right: max(16px, calc(50% - 50vw + 16px));
}
@media (max-width: 820px){ .timeline{ width:auto; margin:0 16px; } }

.track{ position:relative; width:100%; height: 360px; }

/* ── БАЗОВАЯ ТОНКАЯ ЛИНИЯ ────────────────────────────────────────── */
.base-line{
  position:absolute; height:4px;
  top: var(--lineY); transform:translateY(-50%);
  left: var(--tl-gutter-h); right: var(--tl-gutter-h);
  background: var(--indigo-600);
  z-index:2;
}

/* ── ЛИНИЯ БЛОКИРОВКИ (ТОЛСТАЯ, ПАРАЛЛЕЛЬНАЯ) ───────────────────── */
.freeze-line{
  position:absolute; height:12px; border-radius:8px;
  top: calc(var(--lineY) + var(--freeze-offset));
  background: var(--freeze);
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
  z-index:2;
}

/* «дорога» Сен 2020 → Июл 2021 (тонкая над базовой) */
.intro-road{ position:absolute; height:2px; top:calc(var(--lineY) - 1px); background:var(--indigo-300); opacity:.9; border-radius:2px; z-index:3; }

/* точки/кластеры — единый цвет */
.dot,.cluster-dot{
  position:absolute; width:16px; height:16px; border-radius:50%;
  background: var(--dot-color); outline:1px solid var(--trus-border);
  box-shadow:0 0 0 2px rgba(0,0,0,.25); cursor:pointer;
  transform:translate(-50%,-50%); z-index:4;
}

/* подписи: вертикально над базовой; теперь места больше */
.label{ position:absolute; font-size:12px; color:var(--trus-muted); text-shadow:0 1px 0 rgba(0,0,0,.35); white-space:nowrap; }
@media (min-width: 821px){
  .label{ transform: translate(-50%, -140%) rotate(180deg); writing-mode: vertical-rl; text-orientation: mixed; }
}

/* Маркер «Сейчас» */
.now-marker{ position:absolute; background:var(--now-color); border-radius:2px; animation: trusPulse 1.9s ease-out infinite; z-index:5; }

/* ── Мобильная (вертикальная) версия ─────────────────────────────── */
@media (max-width:820px){
  .track{ height: 1200px; }
  .base-line{
    left:44px; width:4px; height: calc(100% - 44px);
    top: calc(var(--tl-gutter-v) * 1); bottom: calc(var(--tl-gutter-v) * 1); transform:none;
  }
  .freeze-line{
    left: calc(44px + var(--freeze-offset)); width:12px; height: 0; /* высоту задаём скриптом */
    top: 0; bottom:auto; transform:none;
  }
  .dot,.cluster-dot{ left:44px; transform:translate(-50%,0); }
  .label{ left:60px; transform:none; }
}

/* подвал-подсказка */
.hint{ padding:10px 12px; color:var(--trus-muted); font-size:13px; border-top:1px solid var(--trus-border); background:var(--trus-panel); }

/* ── Модалка (коротко, как раньше) ───────────────────────────────── */
.modal-backdrop{ position:fixed; inset:0; display:none; background:rgba(0,0,20,.55); backdrop-filter:blur(2px); z-index:9999; }
.modal-backdrop.show{ display:flex; align-items:center; justify-content:center; }
.modal-dialog{
  max-width:720px; width:clamp(320px,90vw,720px); max-height:80vh; overflow:auto;
  background:var(--trus-panel); border:1px solid var(--trus-border); border-radius:16px; box-shadow:var(--shadow); padding:16px 18px;
}
.modal-title{ margin:0 0 6px 0; font-size:18px; }
.modal-when{ color:var(--trus-muted); font-size:13px; margin-bottom:8px; }
.modal-summary{ font-size:14px; margin-bottom:10px; color:#d9e2ee; }
.modal-details{ font-size:14px; color:#c8d3e0; display:none; }
.modal-actions{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
.btn{ background:var(--trus-panel-2); color:var(--trus-text); border:1px solid var(--trus-border); border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; }
.btn:hover{ filter:brightness(1.08); }
.btn-close{ margin-left:auto; }

.modal-list{ display:none; }
.modal-item{ padding-top:10px; margin-top:10px; border-top:1px dashed var(--trus-border); }
.modal-item-row{ display:flex; align-items:flex-start; gap:10px; }
.modal-item-col{ flex:1 1 auto; }
.modal-item-actions{ flex:0 0 auto; }
.modal-item-when{ color:var(--trus-muted); font-size:13px; margin-bottom:6px; }
.modal-item-title{ font-weight:600; margin-bottom:2px; }
.modal-item-details{ display:none; margin-top:6px; color:#c8d3e0; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="roadmap-head">
      <h1 class="roadmap-title">Юридическая хронология (демо)</h1>
      <div class="roadmap-meta" id="meta">Загрузка…</div>
    </div>
  </div>

  <div class="timeline">
    <div class="track" id="track">
      <div class="base-line"></div>
      <div class="freeze-line" id="freeze"></div>
      <div class="now-marker" id="now"></div>
    </div>
    <div class="hint">Две параллельные линии: тонкая — общая шкала; толстая — период блокировки. Клик по точке — модалка.</div>
  </div>

  <!-- Модалка -->
  <div class="modal-backdrop" id="modalBack" aria-modal="true" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-dialog" role="document">
      <h2 class="modal-title" id="modalTitle"></h2>
      <div class="modal-when" id="mWhen"></div>
      <div class="modal-summary" id="mSummary"></div>
      <div class="modal-details" id="mDetails"></div>
      <div class="modal-list" id="mList"></div>
      <div class="modal-actions">
        <button class="btn" id="toggleDetails">Подробнее</button>
        <button class="btn btn-close" id="closeModal">Закрыть</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  const res = await fetch('./legal-timeline.json', {cache:'no-store'});
  if(!res.ok){ document.getElementById('meta').textContent = 'Не удалось загрузить legal-timeline.json'; return; }
  const data = await res.json();

  /* ===== Utils ===== */
  const parseYM = s=>{
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00Z');
    if(/^\d{4}-\d{2}$/.test(s)) return new Date(s+'-01T00:00:00Z');
    if(/^\d{4}$/.test(s)) return new Date(s+'-01-01T00:00:00Z');
    return new Date(s);
  };
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const esc = s => String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const NBSP = '\u00A0';
  const RU_MON = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
  const isMobile = () => window.matchMedia('(max-width: 820px)').matches;

  /* ===== Domain ===== */
  const items = (data.items||[]).slice().sort((a,b)=>{
    const ad = parseYM(a.date_start||a.date_end);
    const bd = parseYM(b.date_start||b.date_end);
    return ad - bd;
  });
  const firstDate = parseYM(items[0].date_start || items[0].date_end);
  const lastRef = items.reduce((d,it)=> {
    const p = parseYM(it.date_end || it.date_start);
    return p>d ? p : d;
  }, firstDate);
  const today = new Date();
  const domainStart = firstDate;
  const domainEnd = new Date(Math.max(today.getTime(), lastRef.getTime()));
  const spanMs = domainEnd - domainStart;

  const track = document.getElementById('track');
  const nowEl = document.getElementById('now');
  const freezeEl = document.getElementById('freeze');
  const meta = document.getElementById('meta');
  meta.textContent = `Обновлено: ${new Date(data.meta.updated_at).toLocaleString()} • ${data.meta.updated_by} • версия: ${data.meta.version}`;

  // отступы
  const GUTTER_H = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tl-gutter-h'))/100 || 0.06;
  const GUTTER_V = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tl-gutter-v'))/100 || 0.08;

  const posRatio = d => clamp((d - domainStart) / spanMs, 0, 1);
  const posH = r => GUTTER_H + r * (1 - GUTTER_H*2);
  const posV = r => GUTTER_V + r * (1 - GUTTER_V*2);

  /* ===== Clustering (≤ ~2 months) ===== */
  const TWO_MONTHS = 1000*60*60*24*60;
  const points = items.filter(it=>!(it.date_start && it.date_end)); // точечные
  const clusters = [];
  for(const it of points){
    const d = parseYM(it.date_start || it.date_end);
    let c = clusters.find(x => Math.abs(x.center - d) <= TWO_MONTHS);
    if(!c){ c = { center:d, items:[] }; clusters.push(c); }
    else c.center = new Date((c.center.getTime()*c.items.length + d.getTime())/(c.items.length+1));
    c.items.push(it);
  }
  clusters.sort((a,b)=>a.center - b.center);

  /* ===== Подписи и точки ===== */
  clusters.forEach(c=>{
    const dot = document.createElement('div');
    dot.className = 'cluster-dot';

    const label = document.createElement('div');
    label.className = 'label';

    if(isMobile()){
      const y = posV(posRatio(c.center))*100;
      dot.style.left = '44px';
      dot.style.top = `calc(${y}% - 8px)`;
      label.style.left = '60px';
      label.style.top = dot.style.top;
    }else{
      const x = posH(posRatio(c.center))*100;
      dot.style.left = x+'%';
      dot.style.top = 'var(--lineY)';
      label.style.left = dot.style.left;
      label.style.top = 'var(--lineY)';
    }

    if(c.items.length===1){
      label.textContent = c.items[0].when_label || '';
      dot.addEventListener('click', ()=> openModalSingle(c.items[0]));
    } else {
      const ds = c.items.map(i=>parseYM(i.date_start||i.date_end)).sort((a,b)=>a-b);
      const fmt = d => RU_MON[d.getUTCMonth()] + NBSP + d.getUTCFullYear();
      label.textContent = `${fmt(ds[0])} – ${fmt(ds[ds.length-1])}`;
      dot.addEventListener('click', ()=> openModalCluster(c.items));
    }

    track.appendChild(dot);
    track.appendChild(label);
  });

  /* ===== Тонкая «дорога» между Сен 2020 и Июл 2021 над базовой ===== */
  const startRoad = parseYM('2020-09-01');
  const endRoad   = parseYM('2021-07-01');
  if(isMobile()){
    const y1 = posV(posRatio(startRoad))*100, y2 = posV(posRatio(endRoad))*100;
    const road = document.createElement('div');
    road.className = 'intro-road';
    road.style.left = '44px'; road.style.width = '2px';
    road.style.top = `calc(${Math.min(y1,y2)}% - 1px)`;
    road.style.height = Math.max(0.5, Math.abs(y2 - y1)) + '%';
    road.style.transform='translateX(-50%)';
    track.appendChild(road);
  } else {
    const x1 = posH(posRatio(startRoad))*100, x2 = posH(posRatio(endRoad))*100;
    const road = document.createElement('div');
    road.className = 'intro-road';
    road.style.left = Math.min(x1,x2) + '%';
    road.style.width = Math.max(0.5, Math.abs(x2 - x1)) + '%';
    track.appendChild(road);
  }

  /* ===== Линия блокировки: Июл 2021 → Сейчас (параллельно базовой) ===== */
  function renderFreeze(){
    const start = parseYM('2021-07-01');
    const r1 = posRatio(start), r2 = posRatio(new Date());
    if(isMobile()){
      const y1 = posV(r1)*100;
      const y2 = posV(r2)*100;
      freezeEl.style.top = `calc(${Math.min(y1,y2)}% - 6px)`;
      freezeEl.style.height = Math.max(2, Math.abs(y2 - y1)) + '%';
      freezeEl.style.left = `calc(44px + var(--freeze-offset))`;
      freezeEl.style.width = '12px';
    } else {
      const x1 = posH(r1)*100;
      const x2 = posH(r2)*100;
      freezeEl.style.left = Math.min(x1,x2) + '%';
      freezeEl.style.width = Math.max(2, Math.abs(x2 - x1)) + '%';
    }
  }

  /* ===== Маркер «Сейчас» — совпадает с концом линии блокировки ===== */
  function placeNow(){
    const r = posRatio(new Date());
    if(isMobile()){
      nowEl.style.left = '0';
      nowEl.style.width = '100%';
      nowEl.style.height = '3px';
      nowEl.style.top = (posV(r)*100) + '%';
    } else {
      nowEl.style.left = (posH(r)*100) + '%';
      nowEl.style.top = '0'; nowEl.style.bottom = '0';
      nowEl.style.width = '3px'; nowEl.style.height = '';
    }
  }

  renderFreeze();
  placeNow();

  window.addEventListener('resize', ()=> location.reload());

  /* ===== MODALS ===== */
  const back = document.getElementById('modalBack');
  const tTitle = document.getElementById('modalTitle');
  const tWhen = document.getElementById('mWhen');
  const tSummary = document.getElementById('mSummary');
  const tDetails = document.getElementById('mDetails');
  const tList = document.getElementById('mList');
  const btnToggle = document.getElementById('toggleDetails');
  const btnClose = document.getElementById('closeModal');

  function openBackdrop(){ back.classList.add('show'); trapFocus(); }
  function closeBackdrop(){ back.classList.remove('show'); releaseFocus(); }

  function openModalSingle(it){
    tList.style.display='none'; tList.innerHTML='';
    tTitle.textContent = it.title || '';
    tWhen.textContent = it.when_label || '';
    tSummary.textContent = it.summary || '';
    tDetails.innerHTML = esc(it.details || '');
    tDetails.style.display = it.details ? 'none' : 'none';
    btnToggle.style.display = it.details ? '' : 'none';
    openBackdrop();
  }
  function openModalCluster(items){
    const sorted = items.slice().sort((a,b)=>{
      const ad = parseYM(a.date_start||a.date_end), bd = parseYM(b.date_start||b.date_end);
      return ad - bd;
    });
    tTitle.textContent = `События (${sorted.length})`;
    tWhen.textContent = '';
    tSummary.textContent = 'Сгруппированные по времени события.';
    tDetails.style.display='none'; tDetails.innerHTML='';
    btnToggle.style.display='none';

    tList.innerHTML = sorted.map((it,idx) => `
      <div class="modal-item" data-i="${idx}">
        <div class="modal-item-row">
          <div class="modal-item-col">
            <div class="modal-item-title">${esc(it.title||'')}</div>
            <div class="modal-item-when">${esc(it.when_label||'')}</div>
            <div class="modal-summary">${esc(it.summary||'')}</div>
            <div class="modal-item-details">${esc(it.details||'')}</div>
          </div>
          <div class="modal-item-actions">
            ${it.details ? `<button class="btn btn-more" data-i="${idx}">Подробнее</button>` : ``}
          </div>
        </div>
      </div>
    `).join('');
    tList.style.display='block';
    openBackdrop();
  }
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-more');
    if(!btn) return;
    const container = btn.closest('.modal-item');
    const details = container.querySelector('.modal-item-details');
    const vis = details.style.display === 'block';
    details.style.display = vis ? 'none' : 'block';
    btn.textContent = vis ? 'Подробнее' : 'Свернуть';
  });
  btnToggle.addEventListener('click', ()=>{
    const vis = tDetails.style.display==='block';
    tDetails.style.display = vis ? 'none' : 'block';
    btnToggle.textContent = vis ? 'Подробнее' : 'Свернуть';
  });
  btnClose.addEventListener('click', closeBackdrop);
  back.addEventListener('click', (e)=>{ if(e.target === back) closeBackdrop(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeBackdrop(); });

  // focus trap
  let lastFocus = null;
  function trapFocus(){
    lastFocus = document.activeElement;
    const f = back.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
    const first = f[0], last = f[f.length-1];
    first && first.focus();
    back.addEventListener('keydown', onTrap);
    function onTrap(e){
      if(e.key!=='Tab') return;
      if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
    }
  }
  function releaseFocus(){ if(lastFocus) lastFocus.focus(); }

})();
</script>
</body>
</html>
