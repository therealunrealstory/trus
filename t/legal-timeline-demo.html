<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Юридическая хронология — демо</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Подключаем актуальные стили сайта (здесь уже есть единые стили модалок) -->
  <link rel="stylesheet" href="https://therealunrealstory.com/assets/styles.css" />

  <style>
    /* Небольшие локальные стили только для демо-таймлайна */
    :root{ --indigo: #4f46e5; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:#0f172a; color:#e2e8f0;
    }

    .wrap{ max-width:1200px; margin:0 auto; padding:18px 16px 40px; }

    .demo-card{
      position:relative;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.2);
      border-radius:16px;
      padding:44px 36px 90px;
      overflow:hidden;
    }

    .timeline{
      position:relative;
      height:4px;
      background:var(--indigo); /* Indigo 600 */
      border-radius:999px;
      margin:80px auto 0;
    }

    .tick{
      position:absolute; top:50%; transform:translate(-50%,-50%);
      width:14px; height:14px; border-radius:50%;
      background:var(--indigo); cursor:pointer;
    }

    /* Подписи вертикальные (как просили для десктопа), на мобиле — горизонтальные */
    .label{
      position:absolute; transform:translateX(-50%) rotate(-90deg);
      transform-origin:bottom left;
      top:-56px; left:0; font-size:12px; white-space:nowrap;
      color:#e5e7eb;
    }
    @media (max-width: 768px){
      .label{ transform:translateX(-50%); top:-32px; }
    }

    /* Подсказка под карточкой */
    .hint{
      margin-top:14px; color:rgba(255,255,255,.75); font-size:.95rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="demo-card">
      <div id="timeline" class="timeline"></div>
    </div>
    <p class="hint">Шкала вписана в ширину экрана с отступами. Клик по точке — модалка.</p>
  </div>

  <!-- Унифицированная модалка (ID совпадают со структурой на сайте) -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0 0 8px 0"></h3>
      <div id="modalBody"></div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
        <button id="modalClose" class="btn" type="button">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    /** Безопасный парсер дат: 'YYYY-MM' → 'YYYY-MM-01' (Safari) */
    function parseYMD(s){
      if(!s) return new Date(NaN);
      return new Date(/^\d{4}-\d{2}$/.test(s) ? (s + "-01") : s);
    }

    /** Открыть/закрыть модалку (совместимо с общей версткой) */
    (function attachModal(){
      const modal   = document.getElementById('modalBackdrop');
      const mTitle  = document.getElementById('modalTitle');
      const mBody   = document.getElementById('modalBody');
      const mClose  = document.getElementById('modalClose');
      let lastFocus = null;

      window.openLegalModal = (title, html) => {
        mTitle.innerHTML = title || '';
        mBody.innerHTML  = html  || '';
        lastFocus = document.activeElement;
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        modal.querySelector('.modal-dialog')?.focus();
      };

      window.closeLegalModal = () => {
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
        try{ lastFocus?.focus(); }catch{}
      };

      mClose.addEventListener('click', closeLegalModal);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) closeLegalModal(); });
      document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && modal.classList.contains('show')) closeLegalModal();
      });
    })();

    /** Рендер */
    async function boot(){
      const res  = await fetch('legal-timeline.json', { cache:'no-cache' });
      const raw  = await res.json();
      const rows = Array.isArray(raw) ? raw : (raw.items || []);

      // Приводим к единому виду
      const events = rows.map(it => ({
        date:      parseYMD(it.date_start || it.date || it.when),
        whenLabel: it.when_label || it.label || '',
        title:     it.title || '',
        summary:   it.summary || '',
        details:   it.details || ''
      })).filter(e => !isNaN(e.date));

      if(!events.length) return;

      events.sort((a,b)=>a.date-b.date);

      const min = events[0].date.getTime();
      const max = events[events.length-1].date.getTime();
      const span = Math.max(1, max - min);

      const tl = document.getElementById('timeline');

      // Отступы слева/справа, чтобы точки не слипались с краями контейнера
      const padPct = 3.5; // %
      function toPct(t){ return padPct + ( (t - min) / span ) * (100 - padPct*2); }

      events.forEach(ev => {
        const left = toPct(ev.date.getTime());

        // Точка
        const dot = document.createElement('div');
        dot.className = 'tick';
        dot.style.left = left + '%';

        // Подпись
        const label = document.createElement('div');
        label.className = 'label';
        label.style.left = left + '%';
        label.textContent = ev.whenLabel || '';

        dot.addEventListener('click', () => {
          const bodyHtml = `
            <div style="display:flex; flex-direction:column; gap:8px;">
              <div style="font-weight:600">${ev.title ? ev.title : ''}</div>
              ${ev.summary ? `<div>${ev.summary}</div>` : ''}
              ${ev.details ? `
                <button class="btn" type="button" id="moreBtn">Подробнее</button>
                <div id="moreBox" style="display:none; margin-top:10px;">${ev.details}</div>
              ` : ''}
            </div>
          `;
          openLegalModal(`${ev.whenLabel}${ev.title ? ' — ' + ev.title : ''}`, bodyHtml);

          // навешиваем обработчик на кнопку "Подробнее" уже после открытия
          setTimeout(()=>{
            const btn = document.getElementById('moreBtn');
            const box = document.getElementById('moreBox');
            if(btn && box){
              btn.addEventListener('click', ()=>{
                const opened = box.style.display!=='none';
                box.style.display = opened ? 'none' : 'block';
                btn.textContent   = opened ? 'Подробнее' : 'Скрыть';
              });
            }
          }, 0);
        });

        tl.appendChild(dot);
        tl.appendChild(label);
      });
    }

    boot();
  </script>
</body>
</html>
