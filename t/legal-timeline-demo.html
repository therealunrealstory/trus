<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Legal Timeline Demo — TRUS</title>

<!-- Актуальные стили проекта (как в D‑Story) -->
<link rel="stylesheet" href="https://therealunrealstory.com/assets/styles.css" />

<style>
:root{
  /* Палитра */
  --indigo-300:#a5b4fc;   /* светлая линия (предпосылки) */
  --indigo-600:#4f46e5;   /* основная линия (суд) и пунктир будущего */
  --red-500:#ef4444;      /* линия блокировки */

  /* Геометрия и отступы */
  --tl-gutter-h:6%;       /* равные отступы по крайним линиям */
  --tl-gutter-v:8%;
  --lineY:62%;            /* линии ниже середины, чтобы подписи «дышали» */
  --freeze-offset:16px;   /* смещение красной линии относительно базовой */
}

body{margin:0; color:#e7ecf3; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
.wrap{ max-width:1100px; margin:28px auto; padding:0 16px; }
.roadmap-head{ background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:16px 18px; margin-bottom:16px; }
.roadmap-title{ margin:0 0 6px 0; font-size:22px; }
.roadmap-meta{ color:rgba(231,236,243,.7); font-size:14px; }

.timeline{
  position:relative; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12); border-radius:16px;
  overflow:hidden; width: min(1400px, calc(100vw - 32px));
  margin-left: max(16px, calc(50% - 50vw + 16px));
  margin-right: max(16px, calc(50% - 50vw + 16px));
}
.track{ position:relative; width:100%; height:360px; }

/* ── ЛИНИИ ───────────────────────────────────────────────────────── */
/* 1) светлая предварительная: Сен 2020 → Июл 2021 (тонкая над базовой) */
.pre-cause-line{
  position:absolute; height:2px; background:var(--indigo-300);
  top:calc(var(--lineY) - 1px); z-index:3; border-radius:2px;
}

/* 2) базовая судебная: Июл 2021 → Ноя 2026 (тонкая indigo-600) */
.base-line{
  position:absolute; height:4px; background:var(--indigo-600);
  top:var(--lineY); transform:translateY(-50%); z-index:2;
}

/* 3) красная блокировка: Июл 2021 → Сегодня (толстая, параллельно слева на мобайле) */
.freeze-line{
  position:absolute; height:12px; background:var(--red-500); border-radius:8px;
  top: calc(var(--lineY) + var(--freeze-offset)); z-index:3;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
}

/* 4) пунктир будущего: Ноя 2026 → короткий горизонт */
.future-line{
  position:absolute; height:4px; background:transparent;
  top:var(--lineY); transform:translateY(-50%); z-index:2;
  border-top:4px dashed var(--indigo-600);
}

/* Точки/кластеры — единый аккуратный стиль */
.cluster-dot{
  position:absolute; width:16px; height:16px; border-radius:50%;
  background:#ffffff; outline:1px solid rgba(255,255,255,0.12);
  box-shadow:0 0 0 2px rgba(79,70,229,.45); /* ореол индиго */
  cursor:pointer; transform:translate(-50%,-50%); z-index:4;
}

/* Подписи: десктоп — строго одинаковый отступ; мобайл — слева от линии */
.label{
  position:absolute; font-size:12px; color:rgba(231,236,243,.7);
  white-space:nowrap; text-shadow:0 1px 0 rgba(0,0,0,.35); line-height:1.1;
}
@media (min-width: 821px){
  .label{ transform: translate(-50%, -150%) rotate(180deg); writing-mode: vertical-rl; text-orientation: mixed; }
}

/* Маркер «Сейчас» */
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(165,180,252,.6);}70%{box-shadow:0 0 0 12px rgba(165,180,252,0);}100%{box-shadow:0 0 0 0 rgba(165,180,252,0);} }
.now-marker{ position:absolute; background:#a5b4fc; border-radius:2px; animation:pulse 1.9s ease-out infinite; z-index:5; }

/* ── Легенда (графическая) ──────────────────────────────────────── */
.legend{ display:flex; gap:18px; flex-wrap:wrap; padding:10px 12px; border-top:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.05); font-size:13px; color:rgba(231,236,243,.9); }
.legend-item{ display:flex; align-items:center; gap:8px; }
.legend-swatch{ height:6px; border-radius:4px; }
.swatch-pre{ width:44px; background:var(--indigo-300); }
.swatch-base{ width:44px; background:var(--indigo-600); }
.swatch-freeze{ width:44px; height:12px; background:var(--red-500); border-radius:8px; }
.swatch-future{ width:44px; background:transparent; border-top:4px dashed var(--indigo-600); height:0; }

/* ── Мобильная вертикальная версия ──────────────────────────────── */
@media (max-width:820px){
  .track{ height:1200px; }
  /* База (верт.) только от Июл 2021 → Ноя 2026 */
  .base-line{
    left:44px; width:4px; height:auto; transform:none;
  }
  /* Светлая (верт.) Сен 2020 → Июл 2021 */
  .pre-cause-line{
    left:44px; width:2px; transform:none;
  }
  /* Красная линия — СЛЕВА от базовой, чтобы не перекрывать подписи */
  .freeze-line{
    left: calc(44px - var(--freeze-offset));
    width:12px; height:auto;
  }
  /* Пунктир будущего — вертикальный, рядом с базой */
  .future-line{
    left:44px; width:0; height:auto; border-top:none; border-left:4px dashed var(--indigo-600);
    transform:none;
  }
  .cluster-dot{ left:44px; transform:translate(-50%,0); }
  .label{ left:60px; transform:none; }
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="roadmap-head">
      <h1 class="roadmap-title">Юридическая хронология (демо)</h1>
      <div class="roadmap-meta" id="meta">Загрузка…</div>
    </div>
  </div>

  <div class="timeline">
    <div class="track" id="track">
      <!-- линии -->
      <div class="pre-cause-line" id="preLine"></div>
      <div class="base-line" id="baseLine"></div>
      <div class="freeze-line" id="freezeLine"></div>
      <div class="future-line" id="futureLine"></div>
      <!-- «сейчас» -->
      <div class="now-marker" id="now"></div>
    </div>
    <!-- легенда с мини‑отрезками -->
    <div class="legend">
      <div class="legend-item"><span class="legend-swatch swatch-pre"></span><span>Предпосылки (до иска)</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-base"></span><span>Период судебных разбирательств</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-freeze"></span><span>Период блокировки</span></div>
      <div class="legend-item"><span class="legend-swatch swatch-future"></span><span>Судебные перспективы (впереди)</span></div>
    </div>
  </div>

  <!-- Модалка (как в D‑Story: .modal-backdrop/.show) -->
  <div class="modal-backdrop" id="modalBack" aria-modal="true" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-dialog" role="document">
      <h2 id="modalTitle"></h2>
      <div id="mWhen" class="muted"></div>
      <div id="mSummary"></div>
      <div id="mDetails" style="display:none"></div>
      <div id="mList" style="display:none"></div>
      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="toggleDetails">Подробнее</button>
        <button class="btn" id="closeModal" style="margin-left:auto;">Закрыть</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  const res = await fetch('./legal-timeline.json', {cache:'no-store'});
  if(!res.ok){ document.getElementById('meta').textContent = 'Не удалось загрузить legal-timeline.json'; return; }
  const data = await res.json();

  const parseYM = s=>{
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00Z');
    if(/^\d{4}-\d{2}$/.test(s)) return new Date(s+'-01T00:00:00Z');
    if(/^\d{4}$/.test(s)) return new Date(s+'-01-01T00:00:00Z');
    return new Date(s);
  };
  const esc = s => String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const NBSP = '\u00A0';
  const RU_MON = ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
  const isMobile = () => matchMedia('(max-width:820px)').matches;

  const items = (data.items||[]).slice().sort((a,b)=>{
    const ad = parseYM(a.date_start||a.date_end);
    const bd = parseYM(b.date_start||b.date_end);
    return ad - bd;
  });

  document.getElementById('meta').textContent =
    `Обновлено: ${new Date(data.meta.updated_at).toLocaleString()} • ${data.meta.updated_by} • версия: ${data.meta.version}`;

  /* === Референсы для равных отступов по крайним линиям === */
  const PRE_START = parseYM('2020-09-01'); // старт светлой
  const FREEZE_START = parseYM('2021-07-01'); // старт суда/блокировки
  const COURT_END = parseYM('2026-11-01');   // конец базовой
  const FUTURE_MONTHS = 6;                   // длина пунктира
  const FUTURE_END = new Date(COURT_END);  FUTURE_END.setUTCMonth(FUTURE_END.getUTCMonth()+FUTURE_MONTHS);

  // шкала = PRE_START → FUTURE_END (для равных гуттеров)
  const GUTTER_H = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tl-gutter-h'))/100 || 0.06;
  const GUTTER_V = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tl-gutter-v'))/100 || 0.08;

  const domainStart = PRE_START, domainEnd = FUTURE_END, spanMs = domainEnd - domainStart;
  const posRatio = d => clamp((d - domainStart) / spanMs, 0, 1);
  const posH = r => GUTTER_H + r * (1 - GUTTER_H*2);
  const posV = r => GUTTER_V + r * (1 - GUTTER_V*2);

  const track = document.getElementById('track');
  const preLine = document.getElementById('preLine');
  const baseLine = document.getElementById('baseLine');
  const freezeLine = document.getElementById('freezeLine');
  const futureLine = document.getElementById('futureLine');
  const nowEl = document.getElementById('now');

  function setLineSegments(){
    const now = new Date();

    if(isMobile()){
      // 0) Светлая: Сен 2020 → Июл 2021 (вертикаль)
      const y0a = posV(posRatio(PRE_START))*100;
      const y0b = posV(posRatio(FREEZE_START))*100;
      preLine.style.left = '44px'; preLine.style.width = '2px';
      preLine.style.top = `calc(${y0a}% )`;
      preLine.style.height = Math.max(0.5, y0b - y0a) + '%';
      preLine.style.transform = 'translateX(-50%)';

      // 1) База: Июл 2021 → Ноя 2026 (вертикаль). НЕТ линии выше FREEZE_START.
      const y1a = posV(posRatio(FREEZE_START))*100;
      const y1b = posV(posRatio(COURT_END))*100;
      baseLine.style.left = '44px'; baseLine.style.width = '4px';
      baseLine.style.top = `calc(${y1a}% )`;
      baseLine.style.height = Math.max(2, y1b - y1a) + '%';
      baseLine.style.transform = 'none';

      // 2) Красная: Июл 2021 → Сегодня (СЛЕВА от базы)
      const yf1 = posV(posRatio(FREEZE_START))*100;
      const yf2 = posV(posRatio(now))*100;
      freezeLine.style.left = `calc(44px - var(--freeze-offset))`;
      freezeLine.style.top = `calc(${Math.min(yf1,yf2)}% - 6px)`;
      freezeLine.style.height = Math.max(2, Math.abs(yf2 - yf1)) + '%';
      freezeLine.style.width = '12px';

      // 3) Пунктир: Ноя 2026 → FUTURE_END (вертикаль, рядом с базой)
      const yfe1 = posV(posRatio(COURT_END))*100;
      const yfe2 = posV(posRatio(FUTURE_END))*100;
      futureLine.style.left = '44px';
      futureLine.style.top = `calc(${Math.min(yfe1,yfe2)}% )`;
      futureLine.style.height = Math.max(2, Math.abs(yfe2 - yfe1)) + '%';
      futureLine.style.width = '0';

      // Маркер «Сейчас»
      nowEl.style.left = 0; nowEl.style.width = '100%'; nowEl.style.height = '3px';
      nowEl.style.top = (posV(posRatio(now))*100) + '%';
    } else {
      // 0) Светлая: Сен 2020 → Июл 2021 (горизонталь)
      const x0a = posH(posRatio(PRE_START))*100;
      const x0b = posH(posRatio(FREEZE_START))*100;
      preLine.style.left = x0a+'%';
      preLine.style.width = Math.max(0.5, x0b - x0a) + '%';

      // 1) База: Июл 2021 → Ноя 2026 (горизонталь). НЕТ базы до FREEZE_START.
      const x1a = posH(posRatio(FREEZE_START))*100;
      const x1b = posH(posRatio(COURT_END))*100;
      baseLine.style.left = x1a+'%';
      baseLine.style.width = Math.max(2, x1b - x1a) + '%';

      // 2) Красная: Июл 2021 → Сегодня (горизонталь, параллельно ниже)
      const xf1 = posH(posRatio(FREEZE_START))*100;
      const xf2 = posH(posRatio(now))*100;
      freezeLine.style.left = Math.min(xf1, xf2) + '%';
      freezeLine.style.width = Math.max(2, Math.abs(xf2 - xf1)) + '%';

      // 3) Пунктир: Ноя 2026 → FUTURE_END
      const xfe1 = posH(posRatio(COURT_END))*100;
      const xfe2 = posH(posRatio(FUTURE_END))*100;
      futureLine.style.left = Math.min(xfe1,xfe2) + '%';
      futureLine.style.width = Math.max(2, Math.abs(xfe2 - xfe1)) + '%';

      // Маркер «Сейчас»
      const xr = posH(posRatio(now))*100;
      nowEl.style.left = xr+'%'; nowEl.style.top = 0; nowEl.style.bottom = 0;
      nowEl.style.width = '3px'; nowEl.style.height = '';
    }
  }

  /* === Кластеры (≤ 2 мес) + точки/подписи === */
  const TWO_MONTHS = 1000*60*60*24*60;
  const pointItems = items.filter(it => !(it.date_start && it.date_end));
  const clusters = [];
  for(const it of pointItems){
    const d = parseYM(it.date_start || it.date_end);
    let c = clusters.find(x => Math.abs(x.center - d) <= TWO_MONTHS);
    if(!c){ c = { center:d, items:[] }; clusters.push(c); }
    else c.center = new Date((c.center.getTime()*c.items.length + d.getTime())/(c.items.length+1));
    c.items.push(it);
  }
  clusters.sort((a,b)=>a.center - b.center);

  const trackEl = document.getElementById('track');
  clusters.forEach(c=>{
    const dot = document.createElement('div'); dot.className='cluster-dot';
    const label = document.createElement('div'); label.className='label';

    if(isMobile()){
      const y = (posV(posRatio(c.center))*100);
      dot.style.top = `calc(${y}% - 8px)`; dot.style.left = '44px';
      label.style.left='60px'; label.style.top = dot.style.top;
    } else {
      const x = (posH(posRatio(c.center))*100);
      dot.style.left = x+'%'; dot.style.top = 'var(--lineY)';
      label.style.left = dot.style.left; label.style.top = 'var(--lineY)';
    }

    if(c.items.length===1){
      label.textContent = c.items[0].when_label || '';
      dot.addEventListener('click', ()=> openModalSingle(c.items[0]));
    } else {
      const ds = c.items.map(i=>parseYM(i.date_start||i.date_end)).sort((a,b)=>a-b);
      const fmt = d => RU_MON[d.getUTCMonth()] + NBSP + d.getUTCFullYear();
      label.textContent = `${fmt(ds[0])} – ${fmt(ds[ds.length-1])}`;
      dot.addEventListener('click', ()=> openModalCluster(c.items));
    }

    trackEl.appendChild(dot); trackEl.appendChild(label);
  });

  setLineSegments();
  window.addEventListener('resize', ()=> location.reload());

  /* === Модалки (как D‑Story: .modal-backdrop/.show) === */
  const back = document.getElementById('modalBack');
  const tTitle = document.getElementById('modalTitle');
  const tWhen = document.getElementById('mWhen');
  const tSummary = document.getElementById('mSummary');
  const tDetails = document.getElementById('mDetails');
  const tList = document.getElementById('mList');
  const btnToggle = document.getElementById('toggleDetails');
  const btnClose = document.getElementById('closeModal');

  function openBackdrop(){ back.classList.add('show'); }
  function closeBackdrop(){ back.classList.remove('show'); }

  function openModalSingle(it){
    tList.style.display='none'; tList.innerHTML='';
    tTitle.textContent = it.title || '';
    tWhen.textContent = it.when_label || '';
    tSummary.innerHTML = esc(it.summary || '');
    tDetails.innerHTML = esc(it.details || '');
    tDetails.style.display = it.details ? 'none' : 'none';
    btnToggle.style.display = it.details ? '' : 'none';
    openBackdrop();
  }
  function openModalCluster(items){
    const sorted = items.slice().sort((a,b)=>{
      const ad = parseYM(a.date_start||a.date_end), bd = parseYM(b.date_start||b.date_end);
      return ad - bd;
    });
    tTitle.textContent = `События (${sorted.length})`;
    tWhen.textContent = '';
    tSummary.textContent = 'Сгруппированные по времени события.';
    tDetails.style.display='none'; tDetails.innerHTML='';
    btnToggle.style.display='none';
    tList.innerHTML = sorted.map((it,idx)=>`
      <div style="padding-top:10px; margin-top:10px; border-top:1px dashed rgba(255,255,255,.12)">
        <div style="font-weight:600">${esc(it.title||'')}</div>
        <div class="muted" style="margin:4px 0 6px 0">${esc(it.when_label||'')}</div>
        <div>${esc(it.summary||'')}</div>
        ${it.details?`<div id="d-${idx}" style="display:none; margin-top:6px">${esc(it.details)}</div>
        <button class="btn btn-more" data-i="${idx}" style="margin-top:6px">Подробнее</button>`:''}
      </div>
    `).join('');
    tList.style.display='block';
    openBackdrop();
  }

  document.addEventListener('click', e=>{
    const btn = e.target.closest('.btn-more');
    if(!btn) return;
    const id = 'd-'+btn.getAttribute('data-i');
    const el = document.getElementById(id);
    const vis = el.style.display==='block';
    el.style.display = vis?'none':'block';
    btn.textContent = vis?'Подробнее':'Свернуть';
  });

  btnToggle.addEventListener('click', ()=>{
    const vis = tDetails.style.display==='block';
    tDetails.style.display = vis ? 'none' : 'block';
    btnToggle.textContent = vis ? 'Подробнее' : 'Свернуть';
  });
  btnClose.addEventListener('click', closeBackdrop);
  back.addEventListener('click', (e)=>{ if(e.target === back) closeBackdrop(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeBackdrop(); });

})();
</script>
</body>
</html>
