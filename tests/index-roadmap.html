<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Real Unreal Story — Treatment Roadmap (demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f16; --panel:#121826; --muted:#93a0b4; --text:#e9eef7;
      --indigo:#4F46E5; /* Indigo 600 */
      --done:#8fb3ff22; --current:#3b82f616; --plan:#ffc8571a;
      --border:#1e2a3f; --ok:#7bc66a; --warn:#ffc857; --low:#ff7a7a;
    }
    html,body{background:var(--bg);color:var(--text);margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Arial;}
    .wrap{max-width:1000px;margin:40px auto;padding:0 16px;}
    .header{display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap}
    h1{font-size:28px;margin:0}
    .meta{color:var(--muted);font-size:14px}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 20px}
    .chip{border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .chip b{color:var(--text);font-weight:600}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr 1fr}}

    /* Колонки-аккордеон */
    .col{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:visible}
    .col header{margin:0;padding:6px;border-bottom:1px solid var(--border)}
    .toggle{
      display:block;width:100%;box-sizing:border-box;
      background:transparent;color:#cfe0ff;
      border:2px solid transparent;border-radius:12px;
      padding:14px 16px;font-size:16px;letter-spacing:.3px;cursor:pointer;margin:0;
    }
    .toggle:focus{outline:none;box-shadow:0 0 0 2px var(--indigo)}
    /* Подсветка активной секции рамкой Indigo 600 */
    .col:not(.collapsed) .toggle{border-color:var(--indigo)}
    .caret{transition:transform .2s ease}
    .col.collapsed .caret{transform:rotate(-90deg)}
    .list{padding:10px;display:block}
    .col.collapsed .list{display:none}

    /* Карточки событий */
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0;background:#0e1422}
    .item.done{background:var(--done)}
    .item.current{background:var(--current);border-color:var(--indigo)}
    .item.planned,.item.tentative{background:var(--plan)}

    .topline{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .title{font-weight:600}
    .when{color:var(--muted);font-size:13px}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:999px;color:#93a0b4}
    .badge.status-current{border-color:var(--indigo);color:#e4e6ff}
    .badge.status-done{color:#9cc59c;border-color:#355a35}
    .badge.status-planned{color:#e7c37a;border-color:#6a5520}
    .badge.status-tentative{color:#e59a9a;border-color:#6a2a2a}

    .conf{display:inline-flex;gap:2px;vertical-align:middle;margin-left:4px}
    .dot{width:7px;height:7px;border-radius:999px;display:inline-block;background:var(--border)}
    .dot.high{background:var(--ok)}
    .dot.medium{background:var(--warn)}
    .dot.low{background:var(--low)}

    .summary{margin:8px 0 0}
    .details{margin-top:8px;display:none;color:#d6def0}
    .actions{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:#1b2538;border:1px solid var(--border);color:#dfe9ff;font-size:12px;padding:6px 10px;border-radius:8px;cursor:pointer}
    .btn:hover{background:#22304a}

    /* Пульс-индикатор Indigo 600 */
    .nowpulse{
      width:8px;height:8px;border-radius:999px;background:var(--indigo);
      box-shadow:0 0 0 0 rgba(79,70,229,.7);animation:pulse 2s infinite
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(79,70,229,.6)}
      70%{box-shadow:0 0 0 12px rgba(79,70,229,0)}
      100%{box-shadow:0 0 0 0 rgba(79,70,229,0)}
    }

    .notice{margin-top:18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Treatment Roadmap</h1>
      <div class="meta" id="meta"></div>
    </div>

    <div class="legend">
      <span class="chip"><b>Done</b> — completed therapy/events</span>
      <span class="chip"><b>Now</b> — current step <span class="nowpulse" style="margin-left:6px"></span></span>
      <span class="chip"><b>Planned</b> — scheduled/expected</span>
      <span class="chip"><b>Tentative</b> — possible, not confirmed</span>
    </div>

    <div class="grid">
      <section class="col collapsed" id="col-done">
        <header>
          <button class="toggle" aria-expanded="false" aria-controls="list-done">
            <span class="caret">▾</span>
            <span>Completed</span>
          </button>
        </header>
        <div class="list" id="list-done" role="region" aria-label="Completed"></div>
      </section>

      <section class="col" id="col-current">
        <header>
          <button class="toggle" aria-expanded="true" aria-controls="list-current">
            <span class="caret">▾</span>
            <span>Now</span>
          </button>
        </header>
        <div class="list" id="list-current" role="region" aria-label="Now"></div>
      </section>

      <section class="col collapsed" id="col-plans">
        <header>
          <button class="toggle" aria-expanded="false" aria-controls="list-plans">
            <span class="caret">▾</span>
            <span>Plans</span>
          </button>
        </header>
        <div class="list" id="list-plans" role="region" aria-label="Plans"></div>
      </section>
    </div>

    <div class="notice">
      “TBD” = “to be determined” (details/dates not yet defined). This roadmap is informational and not medical advice.
    </div>
  </div>

  <script>
    const esc = (s)=>String(s ?? '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const fmtDate = (iso) => iso ? new Date(iso).toLocaleDateString(undefined,{year:'numeric',month:'short'}) : '';

    // Подтягиваем данные
    fetch('roadmap.json', {cache:'no-cache'})
      .then(r => r.json())
      .then(data => render(data))
      .catch(err => {
        document.getElementById('meta').textContent = 'Failed to load roadmap.json';
        console.error(err);
      });

    // Переключение аккордеона + постоянная подсветка открытого заголовка
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.toggle');
      if(!btn) return;
      const section = btn.closest('.col');
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      section.classList.toggle('collapsed', expanded);
    });

    function enforceDefaultAccordionState(){
      setOpen('col-done', false);
      setOpen('col-plans', false);
      setOpen('col-current', true);
    }
    function setOpen(colId, open){
      const col = document.getElementById(colId);
      if(!col) return;
      col.classList.toggle('collapsed', !open);
      const btn = col.querySelector('.toggle');
      if(btn) btn.setAttribute('aria-expanded', String(open));
    }

    function render(data){
      // Meta
      const m = data.meta || {};
      const when = m.updated_at ? new Date(m.updated_at).toLocaleString() : '—';
      document.getElementById('meta').textContent = `Updated ${when} • ${m.updated_by || ''}`.trim();

      // Split/sort
      const items = (data.items || []).slice().sort(sortByTime);
      const done = items.filter(i => i.status === 'done');
      const current = items.filter(i => i.status === 'current').slice(0,1);
      const plans = items.filter(i => i.status === 'planned' || i.status === 'tentative');

      mountList('list-done', done);
      mountList('list-current', current);
      mountList('list-plans', plans);

      enforceDefaultAccordionState();

      // Deep link: дополнительно раскроем нужную колонку и прокрутим
      const hash = location.hash.replace('#','');
      if(hash){
        const el = document.querySelector(`[data-id="${CSS.escape(hash)}"]`);
        if(el){
          const col = el.closest('.col');
          if(col){ col.classList.remove('collapsed'); col.querySelector('.toggle')?.setAttribute('aria-expanded','true'); }
          el.scrollIntoView({behavior:'smooth', block:'center'});
          el.classList.add('highlight');
        }
      }
    }

    function sortByTime(a,b){
      const getKey = (x)=>{
        const y = Number(x.year) || 0;
        const d = x.date_start || x.date_end || `${y}-01-01`;
        return `${y}-${d}`;
      };
      return getKey(a) > getKey(b) ? 1 : -1;
    }

    function mountList(listId, arr){
      const list = document.getElementById(listId);
      list.innerHTML = '';
      arr.forEach(item => list.appendChild(card(item)));
      if(!arr.length){
        const p = document.createElement('div');
        p.className='item';
        p.textContent = 'No entries yet.';
        list.appendChild(p);
      }
    }

    function card(it){
      const wrap = document.createElement('article');
      wrap.className = `item ${it.status}`;
      wrap.dataset.id = it.id;

      const top = document.createElement('div');
      top.className = 'topline';

      const left = document.createElement('div');
      left.innerHTML = `<div class="title">${esc(it.title)}</div>
                        <div class="when">${esc(it.when_label || labelFromDates(it))}${confidenceDots(it)}</div>`;

      const badges = document.createElement('div');
      badges.className = 'badges';
      // статус
      badges.appendChild(makeBadge(statusLabel(it.status)));
      // типы/метки (отдельными бейджами)
      normalizeLabels(it).forEach(l => badges.appendChild(makeBadge(l)));

      top.append(left, badges);

      const summary = document.createElement('div');
      summary.className = 'summary';
      summary.textContent = it.summary || '';

      const details = document.createElement('div');
      details.className = 'details';
      details.textContent = it.details || '';

      const actions = document.createElement('div');
      actions.className = 'actions';
      const toggle = document.createElement('button');
      toggle.className = 'btn';
      toggle.textContent = 'Details';
      toggle.addEventListener('click', ()=>{
        const vis = details.style.display === 'block';
        details.style.display = vis ? 'none' : 'block';
        toggle.textContent = vis ? 'Details' : 'Hide';
      });
      actions.appendChild(toggle);

      wrap.append(top, summary, details, actions);
      return wrap;
    }

    function statusLabel(s){
      return (s==='done')?'done':
             (s==='current')?'current':
             (s==='planned')?'planned':
             (s==='tentative')?'tentative':s||'';
    }

    // Предпочитаем it.labels[], иначе — сплитим строку type по "+"
    function normalizeLabels(it){
      if (Array.isArray(it.labels) && it.labels.length){
        return it.labels.map(cleanLabel);
      }
      if (typeof it.type === 'string' && it.type.trim()){
        return it.type.split('+').map(cleanLabel);
      }
      return [];
    }
    function cleanLabel(s){ return (s||'').toString().trim().toLowerCase(); }

    function makeBadge(text){
      const t = (text||'').toLowerCase();
      const span = document.createElement('span');
      let cls = 'badge';
      if(['done','current','planned','tentative'].includes(t)){
        cls += ' status-'+t;
      }
      span.className = cls;
      span.textContent = pretty(t);
      return span;
    }

    function pretty(t){
      const map = {'rt':'RT','car‑t':'CAR‑T','car-t':'CAR‑T','tki':'TKI','mi':'MI'};
      if(map[t]) return map[t];
      return t.split(' ').map(w => w ? (w[0].toUpperCase()+w.slice(1)) : w).join(' ');
    }

    function labelFromDates(it){
      const a = fmtDate(it.date_start);
      const b = fmtDate(it.date_end);
      if(a && b) return `${a} – ${b}`;
      return a || b || (it.year ? String(it.year) : 'TBD');
    }

    function confidenceDots(it){
      if(!(it.status==='planned' || it.status==='tentative')) return '';
      const c = (it.confidence||'').toLowerCase();
      const dots =
        c==='high' ? '<span class="dot high"></span><span class="dot high"></span><span class="dot high"></span>' :
        c==='medium' ? '<span class="dot medium"></span><span class="dot medium"></span><span class="dot"></span>' :
        '<span class="dot low"></span><span class="dot"></span><span class="dot"></span>';
      return ` · confidence <span class="conf">${dots}</span>`;
    }
  </script>
</body>
</html>