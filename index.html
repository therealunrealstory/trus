<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Real Unreal Story — support for Adam</title>
  <meta name="description" content="The Real Unreal Story — the true story of a surgeon who saved others all his life and is now fighting for his own." />

  <!-- Hreflang (относительные ссылки, чтобы работать и из подпапки) -->
  <link rel="alternate" hreflang="x-default" href="?lang=EN">
  <link rel="alternate" hreflang="en" href="?lang=EN">
  <link rel="alternate" hreflang="es" href="?lang=ES">
  <link rel="alternate" hreflang="fr" href="?lang=FR">
  <link rel="alternate" hreflang="it" href="?lang=IT">
  <link rel="alternate" hreflang="de" href="?lang=DE">
  <link rel="alternate" hreflang="pt" href="?lang=PT">
  <link rel="alternate" hreflang="ru" href="?lang=RU">
  <link rel="alternate" hreflang="zh" href="?lang=CN">
  <link rel="alternate" hreflang="ar" href="?lang=AR">

  <!-- Icons / PWA -->
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="icon" sizes="32x32" href="favicon-32.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#0b0b0b">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Splide (карусель сердец) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

  <style>
    body{ background:#000 url('images/bg.png') center/cover fixed no-repeat; }
    #map{ height:360px }
    /* шапка с прозрачностью как у секций */
    header{ background:rgba(0,0,0,0.2); border-radius:1rem; margin-top:1rem; padding:1rem; color:#fff; }
    section, footer{ background:rgba(0,0,0,0.2); border-radius:1rem; margin-top:1rem; padding:1rem; color:#fff; }
    .icon-btn{ display:inline-flex; align-items:center; gap:8px }
    .icon-btn svg{ width:18px; height:18px }
    .tile{ position:relative; overflow:hidden; border-radius:1rem; height:180px; background-size:cover; background-position:center; cursor:pointer; border:1px solid rgba(255,255,255,.08) }
    .tile::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg,transparent,rgba(0,0,0,.6)) }
    .tile>span{ position:absolute; left:1rem; bottom:1rem; z-index:1; background:rgba(0,0,0,.55); padding:.4rem .7rem; border-radius:.8rem }
    .video-wrap{ position:relative; width:100%; padding-top:56.25%; border-radius:1rem; overflow:hidden; border:1px solid rgba(255,255,255,.08) }
    .video-wrap iframe{ position:absolute; inset:0; width:100%; height:100% }
    .modal-backdrop{ display:none; z-index:9999; } .modal-backdrop.show{ display:block }
    /* пульсирующая кнопка */
    @keyframes pulse {
      0% { transform:scale(1); box-shadow:0 0 0 0 rgba(99,102,241,.6); }
      70%{ transform:scale(1.03); box-shadow:0 0 0 12px rgba(99,102,241,0); }
      100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(99,102,241,0); }
    }
    .pulse{ animation:pulse 2s infinite; }

    /* RTL косметика */
    html[dir="rtl"] .icon-btn { flex-direction: row-reverse; }
    html[dir="rtl"] .icon-btn svg { margin-left: 6px; margin-right: 0; }

    /* caret для хэштега */
    .hashtag-caret { animation: hashblink 1s step-start infinite; }
    @keyframes hashblink { 50% { opacity: 0; } }
  </style>
</head>
<body class="text-white">
  <!-- HEADER: слева — хэштег; справа — кнопка аудио и селектор языка -->
  <header class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between gap-3">
      <!-- ЛЕВО: хэштег с эффектом печати -->
      <div id="hashtagBtn" class="font-mono text-xs sm:text-sm text-white/90 cursor-pointer select-none flex items-center" title="#TheRealUnrealStory" aria-label="#TheRealUnrealStory">
        <span id="hashtagType">#TheRealUnrealStory</span><span class="hashtag-caret ml-0.5">|</span>
      </div>
      <!-- ПРАВО: на мобиле — столбцом, на ≥sm — в строку -->
      <div class="flex gap-2 items-end sm:items-center sm:flex-row flex-col">
        <button id="audioBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm pulse" data-i18n="audio.play">Story in music</button>
        <select id="lang" class="px-3 py-2 rounded bg-gray-800 text-white text-sm">
          <option value="EN" selected>EN</option>
          <option value="ES">ES</option><option value="FR">FR</option>
          <option value="PT">PT</option><option value="DE">DE</option><option value="IT">IT</option>
          <option value="RU">RU</option><option value="CN">CN</option><option value="AR">AR</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Соцсети -->
<section class="max-w-5xl mx-auto px-4">
  <div class="flex items-center gap-3">
    <!-- слева: соцсети -->
    <div class="flex items-center gap-3 flex-wrap grow">
      <a class="icon-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-900/40 shadow-sm" href="https://instagram.com/theRealUnrealStory" target="_blank" rel="noreferrer">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 2.2A2.8 2.8 0 1 0 12 15.8 2.8 2.8 0 0 0 12 9.2zm4.8-2.5a1.1 1.1 0 1 1 0 2.2 1.1 1.1 0 0 1 0-2.2z"/></svg>
        Instagram
      </a>
      <a class="icon-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-900/40 shadow-sm" href="https://t.me/theRealUnrealStory" target="_blank" rel="noreferrer">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9.96 15.47l-.4 5.63c.57 0 .81-.24 1.1-.53l2.64-2.53 5.47 4c1.01.56 1.73.27 2-.93l3.62-16.97c.32-1.5-.54-2.08-1.52-1.72L1.2 9.65c-1.46.57-1.44 1.39-.25 1.76l5.54 1.73 12.85-8.11c.6-.39 1.15-.17.7.22"/></svg>
        Telegram
      </a>
      <a class="icon-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-900/40 shadow-sm" href="https://www.youtube.com/@theRealUnrealStory" target="_blank" rel="noreferrer">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 0 0 .5 6.2 31 31 0 0 0 0 12a31 31 0 0 0 .6 5.8 3 3 0 0 0 2.1 2.1c1.9.6 9.3.6 9.3.6s7.5 0 9.4-.6a3 3 0 0 0 2.1-2.1A31 31 0 0 0 24 12a31 31 0 0 0-.6-5.8zM9.6 15.5v-7l6.2 3.5-6.2 3.5z"/></svg>
        YouTube
      </a>
      <a class="icon-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-900/40 shadow-sm" href="https://open.spotify.com" target="_blank" rel="noreferrer">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 1.5a10.5 10.5 0 1 0 0 21 10.5 10.5 0 0 0 0-21zm4.84 15.2c-.19.3-.6.39-.9.2-2.44-1.5-5.52-1.84-9.13-1-.35.08-.7-.14-.78-.5-.08-.35.14-.7.5-.78 3.93-.9 7.34-.51 10.02 1.15.3.18.4.6.2.92zm1.28-2.88c-.24.38-.75.5-1.13.26-2.8-1.72-7.08-2.23-10.4-1.2-.43.13-.88-.11-1-.54-.13-.43.1-.88.54-1 3.76-1.12 8.45-.54 11.67 1.4.4.24.52.76.3 1.08zm.1-3.1c-3.23-1.92-8.6-2.1-11.69-1.14-.5.15-1.04-.14-1.2-.66-.15-.5.14-1.04.66-1.2 3.57-1.1 9.46-.86 13.2 1.37.47.28.63.9.35 1.36-.28.48-.9.63-1.32.27z"/></svg>
        Spotify
      </a>
    </div>

    <!-- справа: кнопка установки -->
    <button id="installBtn"
            class="ml-auto shrink-0 px-4 py-2 rounded-xl border border-indigo-500 text-indigo-300 hover:bg-indigo-600/10 text-sm hidden"
            data-i18n="btn.install">
      Install app
    </button>
  </div>
</section>

  <main class="max-w-5xl mx-auto px-4">
    <!-- HERO -->
    <section id="hero">
      <h1 class="text-3xl md:text-5xl font-semibold leading-tight">
        The Real Unreal Story — <span class="text-indigo-600" data-i18n="hero.titleRest">support for Adam</span><span class="align-super text-green-400 text-xl">*</span>
      </h1>
      <p class="mt-4" data-i18n="hero.lead1">
        The true story of a surgeon who spent his life saving others and is now fighting for his own life.
      </p>
      <p class="mt-2 text-xs text-gray-300" data-i18n="hero.note">
        * “Adam” is a pseudonym of a real person. The name has been changed to protect privacy.
      </p>
      <div class="mt-5 flex flex-wrap items-center gap-3">
        <a id="donateHero" target="_blank" class="px-4 py-2 rounded-xl bg-green-500 hover:bg-green-600 text-sm font-medium" data-i18n="btn.donate">Donate</a>
        <button id="shareBtn" class="px-4 py-2 rounded-xl bg-gray-200 text-black text-sm hover:opacity-90" data-i18n="btn.share">Share</button>
        <!-- НОВОЕ: своя кнопка установки PWA (скрыта по умолчанию; показывается при поддержке) -->
      </div>
    </section>

    <!-- 3 ТАЙЛА -->
    <section>
      <div class="grid md:grid-cols-3 gap-4">
        <div id="tile1" class="tile" style="background-image:url('images/1.png')"><span data-i18n="tiles.me">I’m Nico</span></div>
        <div id="tile2" class="tile" style="background-image:url('images/2.png')"><span data-i18n="tiles.about">About Adam</span></div>
        <div id="tile3" class="tile" style="background-image:url('images/3.png')"><span data-i18n="tiles.others">Other people in the story</span></div>
      </div>
    </section>

    <!-- МИНИ-ПЛЕЕР АУДИО-АНОНСА -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="announce.title">Our story announcement</h2>
      <div class="rounded-2xl border border-gray-700 p-4 flex items-center gap-3" style="background:rgba(0,0,0,0.35)">
        <button id="announceBtn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm pulse" data-i18n="announce.play">▶︎ Play</button>
        <div class="text-sm text-gray-200" data-i18n="announce.short">Short audio announcement</div>
        <div id="announceStatus" class="ml-auto text-xs text-gray-300"></div>
      </div>
      <audio id="announceAudio" preload="auto"></audio>
    </section>

    <!-- ВИДЕО -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="video.title">Video teaser</h2>
      <div class="video-wrap">
        <iframe src="https://www.youtube.com/embed/9bWXMziCmXk" title="YouTube video" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
      </div>
    </section>

    <!-- КРАТКАЯ АУДИО-ВЕРСИЯ ИСТОРИИ -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="short.title">Short version of our story</h2>
      <div class="rounded-2xl border border-gray-700 p-4 flex items-center gap-3" style="background:rgba(0,0,0,0.35)">
        <button id="shortBtn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm pulse" data-i18n="short.play">▶︎ Play</button>
        <div class="text-sm text-gray-200" data-i18n="short.note">About the events from early 2019 to mid-2025.</div>
        <div id="shortStatus" class="ml-auto text-xs text-gray-300"></div>
      </div>
      <audio id="shortAudio" preload="auto"></audio>
    </section>

    <!-- ПОДДЕРЖАТЬ СЕЙЧАС -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="support.title">Support now</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <!-- Донаты -->
        <div class="p-5 rounded-2xl border border-gray-700" style="background:rgba(0,0,0,0.35)">
          <div class="text-2xl mb-2">💚</div>
          <div class="font-medium mb-2" data-i18n="support.money">Donate funds</div>
          <div class="flex flex-wrap gap-2">
            <a class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm" target="_blank" href="https://www.gofundme.com/f/your-campaign-slug/donate?amount=5">$5</a>
            <a class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm" target="_blank" href="https://www.gofundme.com/f/your-campaign-slug/donate?amount=10">$10</a>
            <a class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm" target="_blank" href="https://www.gofundme.com/f/your-campaign-slug/donate?amount=25">$25</a>
            <a class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm" target="_blank" href="https://www.gofundme.com/f/your-campaign-slug/donate?amount=50">$50</a>
            <a class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm" target="_blank" href="https://www.gofundme.com/f/your-campaign-slug/donate?amount=100">$100</a>
            <a class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm" target="_blank" href="https://www.gofundme.com/f/your-campaign-slug/donate?amount=250">$250</a>
            <a class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm" target="_blank" href="https://www.gofundme.com/f/your-campaign-slug/donate?amount=500">$500</a>
          </div>
        </div>
        <!-- Физическая помощь -->
        <div class="p-5 rounded-2xl border border-gray-700" style="background:rgba(0,0,0,0.35)">
          <div class="text-2xl mb-2">👥</div>
          <div class="font-medium mb-2" data-i18n="support.physical">Practical help</div>
          <button id="wantHelp" class="text-sm underline" data-i18n="btn.wantHelp">I want to help</button>
        </div>
      </div>
    </section>

    <!-- НОВОСТИ -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="news.title">News</h2>
      <div id="tgFeed" class="rounded-2xl border border-gray-700 p-4" style="background:rgba(0,0,0,0.35); max-height:560px; overflow-y:auto;">
        <div class="text-sm text-gray-300" data-i18n="feed.loading">Loading news…</div>
      </div>
      <div class="mt-4">
        <a href="https://t.me/theRealUnrealStory" target="_blank" rel="noreferrer" class="px-4 py-2 rounded-xl bg-sky-600 text-white text-sm hover:bg-sky-700" data-i18n="news.follow">
          Follow our story on Telegram
        </a>
      </div>
    </section>

    <!-- ВОВЛЕЧЁННОСТЬ -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="engage.title">Your engagement</h2>
      <p class="text-sm text-gray-200 mb-3" data-i18n="engage.desc">Mark what you've already done — that’s support too ❤️</p>
      <div id="engageWrap" class="grid sm:grid-cols-2 md:grid-cols-3 gap-3">
        <button class="eng-btn px-4 py-3 rounded-xl border border-gray-700 bg-gray-800/60 text-left" data-i18n="engage.b1">Read/listened to the short version</button>
        <button class="eng-btn px-4 py-3 rounded-xl border border-gray-700 bg-gray-800/60 text-left" data-i18n="engage.b2">Read/listened to the full story</button>
        <button class="eng-btn px-4 py-3 rounded-xl border border-gray-700 bg-gray-800/60 text-left" data-i18n="engage.b3">Listened to tracks about our story</button>
        <button class="eng-btn px-4 py-3 rounded-xl border border-gray-700 bg-gray-800/60 text-left" data-i18n="engage.b4">Subscribed to the Telegram channel</button>
        <button class="eng-btn px-4 py-3 rounded-xl border border-gray-700 bg-gray-800/60 text-left" data-i18n="engage.b5">Subscribed to Instagram</button>
        <button class="eng-btn px-4 py-3 rounded-xl border border-gray-700 bg-gray-800/60 text-left" data-i18n="engage.b6">Shared the story</button>
      </div>
      <p class="mt-2 text-xs text-gray-300" data-i18n="engage.note">Your selections are saved in your browser.</p>
    </section>

    <!-- КАРТА -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="map.title">🌍 Support map</h2>
      <div id="map" class="rounded-2xl shadow-sm border" style="background:#0b0b0b"></div>
      <p class="text-xs text-gray-300 mt-2" data-i18n="map.tip">Be sure to click on the map to specify the exact place of your support.</p>
      <div class="mt-4 grid md:grid-cols-3 gap-3">
        <input id="name" class="px-3 py-2 rounded-xl border bg-gray-800/70 text-white" data-i18n-placeholder="placeholder.name" placeholder="Name" />
        <input id="msg" class="px-3 py-2 rounded-2xl border bg-gray-800/70 text-white md:col-span-2" data-i18n-placeholder="placeholder.msg" placeholder="Message (up to 140 characters)" maxlength="140" />
      </div>
      <div class="grid md:grid-cols-3 gap-3 mt-2">
        <button id="addMark" class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm col-span-1" data-i18n="btn.addMark">Add</button>
        <div class="col-span-2 text-xs text-gray-300 flex items-center" data-i18n="map.dataNote">Data is stored in the database</div>
      </div>
      <div class="mt-2 text-sm text-gray-300">
        <span data-i18n="map.totalLabel">Total marks:</span> <span id="marksCount">0</span>
      </div>
    </section>

    <!-- СЕРДЦА -->
    <section id="contact">
      <div class="rounded-3xl p-6 shadow-sm border border-gray-700" style="background:rgba(0,0,0,0.35)">
        <div class="text-lg font-semibold mb-3" data-i18n="hearts.title">Hearts of support</div>
        <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2">
          <input id="heartName" class="px-3 py-2 rounded-xl border bg-gray-800/70 text-white text-sm" placeholder="Name" data-i18n-placeholder="placeholder.name" />
          <button id="addHeart" class="px-4 py-2 rounded-xl bg-pink-600 text-white text-sm" data-i18n="btn.addHeart">Leave a heart</button>
        </div>
        <div id="heartsSplide" class="splide mt-6" aria-label="Hearts of support">
          <div class="splide__track"><ul id="heartsSlides" class="splide__list"></ul></div>
        </div>
        <button id="loadMoreHearts" class="mt-4 px-4 py-2 rounded-xl bg-gray-800/60 border border-gray-700 text-sm" data-i18n="btn.loadMoreHearts">Load more hearts</button>
      </div>
    </section>
  </main>

  <footer class="max-w-5xl mx-auto px-4 text-center text-sm text-gray-300" data-i18n="footer.note">
    Thank you for any support—even a repost can change a life.
  </footer>

  <!-- Аудио в шапке -->
  <audio id="bgAudio" preload="auto"></audio>

  <!-- Универсальная модалка -->
  <div id="modalBackdrop" class="modal-backdrop fixed inset-0 bg-black/60">
    <div class="min-h-full flex items-center justify-center p-4">
      <div class="bg-gray-900 text-white rounded-2xl shadow-xl border border-gray-700 max-w-xl w-full p-6 relative">
        <button id="modalClose" class="absolute right-3 top-3 text-gray-400 hover:text-white" aria-label="Close">✕</button>
        <h3 id="modalTitle" class="text-lg font-semibold mb-3"></h3>
        <div id="modalBody" class="text-sm text-gray-200 leading-relaxed"></div>
        <div class="mt-5 text-right"><button id="modalOk" class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600">OK</button></div>
      </div>
    </div>
  </div>

  <script>
    const donateURL = "https://www.gofundme.com/f/your-campaign-slug";

    function getLangFromQuery() {
      try {
        const u = new URL(location.href);
        const p = (u.searchParams.get('lang') || '').toUpperCase();
        const ok = ['EN','ES','FR','IT','DE','PT','RU','CN','AR'];
        return ok.includes(p) ? p : null;
      } catch { return null; }
    }

    // ===== AUDIO SOURCES by language =====
    const audio = document.getElementById('bgAudio');
    const audioBtn = document.getElementById('audioBtn');
    const langSelect = document.getElementById('lang');

    function setAudioForLang(l, autoplay=false){
      const src = `audio/ORUS-${l}.mp3`;
      if(audio.src.endsWith(src)){ if(autoplay && audio.paused) audio.play().catch(()=>{}); return; }
      audio.pause(); audio.src = src; if(autoplay) audio.play().catch(()=>{});
    }

    /* ====== Announcement mini-player ====== */
    const announceAudio=document.getElementById('announceAudio');
    const announceBtn=document.getElementById('announceBtn');
    const announceStatus=document.getElementById('announceStatus');

    function setAnnouncementForLang(l,autoplay=false){
      const src=`audio/ANNOUNCEMENT-${l}.mp3`;
      if(announceAudio.src.endsWith(src)){ if(autoplay && announceAudio.paused) announceAudio.play().catch(()=>{}); return; }
      announceAudio.pause(); announceAudio.src=src;
      announceStatus.textContent = ((I18N && I18N["announce.langLabel"]) || "Language: ") + l;
      if(autoplay) announceAudio.play().catch(()=>{});
    }

    /* ====== Short-story mini-player ====== */
    const shortAudio = document.getElementById('shortAudio');
    const shortBtn   = document.getElementById('shortBtn');
    const shortStatus= document.getElementById('shortStatus');

    function setShortForLang(l, autoplay=false){
      const src = `audio/SHORTSTORY-${l}.mp3`;
      if(shortAudio.src.endsWith(src)){ if(autoplay && shortAudio.paused) shortAudio.play().catch(()=>{}); return; }
      shortAudio.pause(); shortAudio.src = src;
      shortStatus.textContent = ((I18N && I18N["short.langLabel"]) || "Language: ") + l;
      if(autoplay) shortAudio.play().catch(()=>{});
    }

    // ===== Modals
    const modal = document.getElementById('modalBackdrop');
    const mTitle = document.getElementById('modalTitle');
    const mBody  = document.getElementById('modalBody');
    const openModal = (title, html)=>{ mTitle.innerHTML = title; mBody.innerHTML = html; modal.classList.add('show'); };
    const closeModal=()=>modal.classList.remove('show');
    document.getElementById('modalClose').onclick=closeModal; document.getElementById('modalOk').onclick=closeModal;
    modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });

    function t(key, fallback){ return (window.I18N && I18N[key]) || fallback; }

    document.getElementById('tile1').onclick=()=>openModal(
      t('tiles.me','I’m Nico'),
      t('modal.tile1.body', `
        My name is Nico, and I’m Adam’s friend. I became an involuntary participant in this “real-unreal” story.
        I’ve reached out to a wide audience for support — I can’t manage alone anymore.
        So I’m telling our story without embellishment and launching a fundraiser on GoFundMe in parallel.
      `)
    );
    document.getElementById('tile2').onclick=()=>openModal(
      t('tiles.about','About Adam'),
      t('modal.tile2.body', `
        Adam is a wonderful person and a surgeon with unique techniques, a philanthropist. Since 2019, he has faced blood oncology several times.
        In July 2025 — a new severe turn: another form of leukemia. At the same time — personal shocks and losses.
      `)
    );
    document.getElementById('tile3').onclick=()=>openModal(
      t('tiles.others','Other people in the story'),
      t('modal.tile3.body', `
        Adam’s story is full of real surprises. There were incredible helpers — without them he wouldn’t have survived to this day.
        There were also those who deliberately harmed. And there were people whom the universe seemed to bring at the right moment.
      `)
    );
    document.getElementById('wantHelp').onclick=()=>openModal(
      t('support.physical','Practical help'),
      t('modal.help.body', `
        If you are ready to help — whether legal, medical or practical support
        (nurses, caregivers), or if you want to arrange a personal meeting — please write to:
        <a href="mailto:theRealUnrealStory@gmail.com" class="underline">theRealUnrealStory@gmail.com</a>.<br><br>
        We are sincerely grateful to everyone who responds.
      `)
    );

    // ===== Engagement local state
    const engageBtns=[...document.querySelectorAll('.eng-btn')];
    const ENG_KEY='engagement_v1';
    const loadEng=()=>{ try{return JSON.parse(localStorage.getItem(ENG_KEY)||'[]');}catch{return []} };
    const saveEng=a=>{ try{localStorage.setItem(ENG_KEY,JSON.stringify(a));}catch{} };
    function applyEng(){ const on=loadEng(); engageBtns.forEach((b,i)=>{const s=on.includes(i); b.classList.toggle('bg-green-700',s); b.classList.toggle('border-green-400',s);}); }
    engageBtns.forEach((b,i)=>b.addEventListener('click',()=>{const on=loadEng(); const p=on.indexOf(i); if(p>=0) on.splice(p,1); else on.push(i); saveEng(on); applyEng();}));
    applyEng();

    // ===== Telegram feed
    async function renderTgFeed(){
      try{
        const box=document.getElementById('tgFeed');
        box.innerHTML = `<div class="text-sm text-gray-300">${t("feed.loading","Loading news…")}</div>`;
        const res=await fetch('/.netlify/functions/news?limit=30',{cache:'no-store'});
        if(!res.ok) throw new Error('news API '+res.status);
        const arr=await res.json();
        if(!Array.isArray(arr)||!arr.length){ box.innerHTML=`<div class="text-sm text-gray-300">${t("feed.empty","No posts yet.")}</div>`; return; }
        box.innerHTML=arr.map(p=>{
          const dt=p.date?new Date(p.date):null, time=dt?dt.toLocaleString():'';
          const link=p.link?`<a href="${p.link}" target="_blank" class="underline text-sky-400">${t("feed.openTelegram","Open in Telegram")}</a>`:'';
          const text=(p.text||'').replace(/\n/g,'<br>');
          const _img = (p.media_type==='photo' && p.media_path) ? `/.netlify/functions/tg-file?path=${encodeURIComponent(p.media_path)}` : null;
          const mediaHtml = _img
            ? `<img src="${_img}"
                     alt=""
                     class="mt-2 rounded-xl border border-gray-700 max-w-full max-h-52 sm:max-h-52 w-auto object-contain block cursor-zoom-in"
                     onclick="openModal('', '<img src=&quot;${_img}&quot; class=&quot;w-full h-auto rounded-xl&quot;>')">`
            : '';
          return `<article class="mb-4 p-3 rounded-xl bg-gray-900/50 border border-gray-700">
                    <div class="text-xs text-gray-300 mb-2">${time}${link?` · ${link}`:''}</div>
                    ${text ? `<div class="text-sm leading-relaxed">${text}</div>` : ''}
                    ${mediaHtml}
                  </article>`;
        }).join('');
      }catch(e){
        console.error(e); document.getElementById('tgFeed').innerHTML=`<div class="text-sm text-red-400">${t("feed.error","Failed to load news.")}</div>`;
      }
    }
    renderTgFeed();

    // ===== Map (paged)
    const map=L.map('map').setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
    const layer=L.layerGroup().addTo(map);
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude}=pos.coords; map.setView([latitude,longitude],6);
        L.marker([latitude,longitude]).addTo(map).bindPopup(t("map.youAreHere","You are here")).openPopup();
      },()=>{});
    }
    let selectedLatLng=null, previewMarker=null;
    map.on('click', e=>{
      selectedLatLng=e.latlng; if(previewMarker) previewMarker.remove();
      previewMarker=L.marker([selectedLatLng.lat,selectedLatLng.lng],{draggable:true}).addTo(map).bindPopup(t("map.selectedPoint","Selected point (you can drag)")).openPopup();
      previewMarker.on('dragend',()=>{selectedLatLng=previewMarker.getLatLng();});
    });
    function setMarksCount(n){ const el=document.getElementById('marksCount'); if(el) el.textContent=Number.isFinite(n)?String(n):'0'; }

    let marksOffset = 0;
    const marksPageSize = 500;
    async function fetchMarksPage() {
      const r = await fetch(`/.netlify/functions/marks?limit=${marksPageSize}&offset=${marksOffset}`, { cache: 'no-store' });
      const chunk = await r.json();
      return Array.isArray(chunk) ? chunk : [];
    }
    function drawMarksBatch(points, batch=300) {
      let i = 0;
      function step() {
        const end = Math.min(i + batch, points.length);
        for (; i < end; i++) {
          const m = points[i];
          const lat = Number(m.lat), lon = Number(m.lon);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
          L.circleMarker([lat, lon], { radius:4, color:'lime' })
            .bindPopup(`<b>${m.name||'Anon'}</b><br>${m.message||''}`)
            .addTo(layer);
        }
        if (i < points.length) requestAnimationFrame(step);
      }
      step();
    }
    async function loadAllMarksPaged() {
      layer.clearLayers();
      let total = 0;
      while (true) {
        const chunk = await fetchMarksPage();
        if (!chunk.length) break;
        total += chunk.length;
        drawMarksBatch(chunk, 300);
        marksOffset += chunk.length;
        if (chunk.length < marksPageSize) break;
      }
      setMarksCount(total);
    }
    loadAllMarksPaged();

    document.getElementById('addMark').addEventListener('click', async ()=>{
      const name=document.getElementById('name').value.trim();
      const message=document.getElementById('msg').value.trim();
      if(!message) return alert(t("alert.enterMessage","Enter a message"));
      if(!selectedLatLng) return alert(t("alert.clickMapFirst","Click on the map first!"));
      const {lat,lng}=selectedLatLng;
      const resp=await fetch('/.netlify/functions/marks',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name,message,lat,lon:lng})});
      if(!resp.ok){ const tt=await resp.text().catch(()=>'-'); alert((t("error.saveFailed","Save error: ")) + tt); return; }
      document.getElementById('msg').value=''; selectedLatLng=null; if(previewMarker){previewMarker.remove(); previewMarker=null;}
      marksOffset = 0;
      loadAllMarksPaged();
    });

    // ===== Hearts + Splide (12 per slide, paged)
    let splide;
    function chunk(a,s){const out=[];for(let i=0;i<a.length;i+=s) out.push(a.slice(i,i+s));return out;}
    function heartCard(n){return `<div class="p-4 rounded-2xl bg-gray-900/50 shadow-sm border border-gray-700"><div class="flex items-center gap-2"><span class="text-xl">❤️</span><div class="text-sm text-gray-200">${n||'Anon'}</div></div></div>`;}
    function renderHeartsSlides(arr){
      const pages=chunk(arr,12), ul=document.getElementById('heartsSlides');
      ul.innerHTML=pages.map(p=>`<li class="splide__slide"><div class="grid md:grid-cols-3 gap-3">${p.map(x=>heartCard(x.name)).join('')}</div></li>`).join('')
        || `<li class="splide__slide"><div class="text-sm text-gray-300">${t("hearts.empty","No hearts yet.")}</div></li>`;
      if(splide) splide.destroy(true);
      splide=new Splide('#heartsSplide',{type:'slide',perPage:1,perMove:1,pagination:true,arrows:true,classes:{pagination:'splide__pagination mt-4'}}); splide.mount();
    }

    let heartsOffset = 0;
    const heartsPageSize = 200;
    let allHearts = [];

    async function fetchHeartsPage() {
      const r = await fetch(`/.netlify/functions/hearts?limit=${heartsPageSize}&offset=${heartsOffset}`, { cache: 'no-store' });
      const chunk = await r.json();
      if (!Array.isArray(chunk)) return [];
      return chunk;
    }

    async function loadMoreHearts() {
      const chunk = await fetchHeartsPage();
      const btn = document.getElementById('loadMoreHearts');
      if (!chunk.length) {
        btn?.setAttribute('disabled','disabled');
        btn?.classList.add('opacity-50','cursor-not-allowed');
        return;
      }
      allHearts = allHearts.concat(chunk);
      heartsOffset += chunk.length;
      renderHeartsSlides(allHearts);
      if (chunk.length < heartsPageSize) {
        btn?.setAttribute('disabled','disabled');
        btn?.classList.add('opacity-50','cursor-not-allowed');
      }
    }

    document.getElementById('loadMoreHearts')?.addEventListener('click', loadMoreHearts);
    loadMoreHearts(); // первая порция

    document.getElementById('addHeart').addEventListener('click', async ()=>{
      const inp=document.getElementById('heartName'); const name=(inp.value||'').trim();
      await fetch('/.netlify/functions/hearts',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name})});
      inp.value='';
      allHearts = []; heartsOffset = 0;
      const btn = document.getElementById('loadMoreHearts');
      btn?.removeAttribute('disabled'); btn?.classList.remove('opacity-50','cursor-not-allowed');
      loadMoreHearts();
    });

    // ===== Share (вставляем текущий язык)
    document.getElementById('shareBtn').addEventListener('click', async () => {
      try {
        const u = new URL(location.href);
        u.searchParams.set('lang', document.getElementById('lang').value);
        const url = u.toString();
        if (navigator.share) {
          await navigator.share({ title: 'The Real Unreal Story', url });
        } else {
          await navigator.clipboard.writeText(url);
          alert((I18N && I18N["share.copied"]) || 'Link copied');
        }
      } catch {}
    });

    // ===== I18N loader
    const LOCALE_DIRS = { AR:"rtl", CN:"ltr", DE:"ltr", EN:"ltr", ES:"ltr", FR:"ltr", IT:"ltr", PT:"ltr", RU:"ltr" };
    let I18N = {};

    // дефолты из DOM как универсальный fallback
    const DEFAULT_I18N = {};
    (function captureDefaultI18n(){
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        if (!(key in DEFAULT_I18N)) DEFAULT_I18N[key] = el.innerHTML;
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        const key = el.getAttribute("data-i18n-placeholder");
        if (!(key in DEFAULT_I18N)) DEFAULT_I18N[key] = el.getAttribute("placeholder") || "";
      });
    })();

    async function fetchLocaleJson(lang){
      // 1) относительный путь (работает в подпапках)
      try {
        const r1 = await fetch(`i18n/${lang}.json`, { cache: 'no-store' });
        if (r1.ok) return await r1.json();
      } catch {}
      // 2) абсолютный путь (на домене)
      try {
        const r2 = await fetch(`/i18n/${lang}.json`, { cache: 'no-store' });
        if (r2.ok) return await r2.json();
      } catch {}
      return null;
    }

    async function loadLocale(lang) {
      try {
        const data = await fetchLocaleJson(lang);
        I18N = data || {};
        window.I18N = I18N;
      } catch {
        I18N = {}; window.I18N = {};
      }

      document.documentElement.lang = (lang || 'en').toLowerCase();
      document.documentElement.dir  = LOCALE_DIRS[lang] || 'ltr';

      const titleRest = I18N["meta.titleRest"] || DEFAULT_I18N["hero.titleRest"] || "support for Adam";
      document.title = `The Real Unreal Story — ${titleRest}`;

      if (I18N["meta.description"]) {
        let m = document.querySelector('meta[name="description"]');
        if (!m) { m = document.createElement('meta'); m.setAttribute('name','description'); document.head.appendChild(m); }
        m.setAttribute('content', I18N["meta.description"]);
      }

      // применяем переводы/дефолты
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        const val = (I18N[key] ?? DEFAULT_I18N[key]);
        if (val != null) el.innerHTML = val;
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        const key = el.getAttribute("data-i18n-placeholder");
        const val = (I18N[key] ?? DEFAULT_I18N[key]);
        if (val != null) el.setAttribute('placeholder', val);
      });

      // кнопки/лейблы с учётом состояния плееров
      if (audioBtn) {
        audioBtn.textContent = audio.paused
          ? (I18N["audio.play"] || DEFAULT_I18N["audio.play"] || "Story in music")
          : (I18N["audio.pause"] || "Pause");
      }
      if (announceBtn) {
        announceBtn.textContent = announceAudio.paused
          ? (I18N["announce.play"] || DEFAULT_I18N["announce.play"] || "▶︎ Play")
          : (I18N["announce.pause"] || "⏸ Pause");
      }
      if (announceStatus) {
        announceStatus.textContent = (I18N["announce.langLabel"] || DEFAULT_I18N["announce.langLabel"] || "Language: ") + lang;
      }

      // новый блок: подписи и язык
      if (shortBtn) {
        shortBtn.textContent = shortAudio.paused
          ? (I18N["short.play"] || DEFAULT_I18N["short.play"] || "▶︎ Play")
          : (I18N["short.pause"] || "⏸ Pause");
      }
      if (shortStatus) {
        shortStatus.textContent = (I18N["short.langLabel"] || DEFAULT_I18N["short.langLabel"] || "Language: ") + lang;
      }

      // треки под язык (сохраняя состояние)
      setAudioForLang(lang, !audio.paused);
      setAnnouncementForLang(lang, !announceAudio.paused);
      setShortForLang(lang, !shortAudio.paused);
    }

    // ===== PWA install: слушаем ранние события (до DOMContentLoaded)
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const b = document.getElementById('installBtn');
      if (b) b.classList.remove('hidden');
    });
    window.addEventListener('appinstalled', () => {
      const b = document.getElementById('installBtn');
      b?.classList.add('hidden');
    });

    // ===== Init on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      const d = document.getElementById('donateHero'); if (d) d.href = donateURL;

      const fromQuery = getLangFromQuery();
      const initialLang = fromQuery || localStorage.getItem('site_lang') || 'EN';
      langSelect.value = initialLang;
      localStorage.setItem('site_lang', initialLang);
      loadLocale(initialLang);

      if (fromQuery) {
        const u = new URL(location.href);
        u.searchParams.delete('lang');
        history.replaceState({}, '', u);
      }

      langSelect.addEventListener('change', e => {
        const l = e.target.value;
        localStorage.setItem('site_lang', l);
        const u = new URL(location.href);
        u.searchParams.set('lang', l);
        history.replaceState({}, '', u);
        loadLocale(l);
      });

      audioBtn.addEventListener('click', async ()=>{
        if(audio.paused){
          setAudioForLang(langSelect.value);
          try{ await audio.play(); audioBtn.textContent = (I18N && I18N["audio.pause"]) || "⏸ Pause"; }catch{}
        } else {
          audio.pause(); audioBtn.textContent = (I18N && I18N["audio.play"]) || (DEFAULT_I18N["audio.play"] || "Story in music");
        }
      });
      announceBtn.addEventListener('click', async ()=>{
        if(announceAudio.paused){
          setAnnouncementForLang(langSelect.value);
          try{ await announceAudio.play(); announceBtn.textContent=(I18N && I18N["announce.pause"]) || "⏸ Pause"; }catch{}
        } else {
          announceAudio.pause(); announceBtn.textContent=(I18N && I18N["announce.play"]) || (DEFAULT_I18N["announce.play"] || "▶︎ Play");
        }
      });
      announceAudio.addEventListener('ended',()=>{ announceBtn.textContent=(I18N && I18N["announce.play"]) || (DEFAULT_I18N["announce.play"] || "▶︎ Play"); });

      // события для короткой версии
      shortBtn.addEventListener('click', async ()=>{
        if(shortAudio.paused){
          setShortForLang(langSelect.value);
          try{ await shortAudio.play(); shortBtn.textContent=(I18N && I18N["short.pause"]) || "⏸ Pause"; }catch{}
        } else {
          shortAudio.pause(); shortBtn.textContent=(I18N && I18N["short.play"]) || (DEFAULT_I18N["short.play"] || "▶︎ Play");
        }
      });
      shortAudio.addEventListener('ended',()=>{ shortBtn.textContent=(I18N && I18N["short.play"]) || (DEFAULT_I18N["short.play"] || "▶︎ Play"); });

      // Хэштег: эффект печати по кругу + клик = модалка-CTA
      (function initHashtag() {
        const el = document.getElementById('hashtagType');
        const btn = document.getElementById('hashtagBtn');
        if (!el || !btn) return;

        const TEXT = '#TheRealUnrealStory';
        let i = 0, dir = 1;
        const typeDelay = 90, eraseDelay = 45, pause = 900;

        function step() {
          el.textContent = TEXT.slice(0, i);
          if (dir > 0) {
            if (i < TEXT.length) { i++; setTimeout(step, typeDelay); }
            else { setTimeout(() => { dir = -1; step(); }, pause); }
          } else {
            if (i > 0) { i--; setTimeout(step, eraseDelay); }
            else { setTimeout(() => { dir = 1; step(); }, pause); }
          }
        }
        step();

        btn.addEventListener('click', () => {
          openModal(
            t('hashtag.title', '#TheRealUnrealStory'),
            t('hashtag.body',
              `Thank you for using <b>#TheRealUnrealStory</b> when you post or share our story.
               It helps people find and follow the thread.<br><br>
               Use it on Instagram (posts/reels/stories), Telegram, YouTube (titles/descriptions/comments),
               TikTok, X/Twitter, Facebook, blogs & Medium, forums & Reddit, LinkedIn,
               newsletters and even email signatures. Every mention matters — thank you!`
            )
          );
        });
      })();

      // Кнопка установки PWA
      const installBtn = document.getElementById('installBtn');
      // Если уже standalone — не показываем
      if (window.matchMedia('(display-mode: standalone)').matches) {
        installBtn?.classList.add('hidden');
      }
      installBtn?.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          openModal(
            t('pwa.installedTitle', 'Installed'),
            t('pwa.installedBody', 'The app has been added to your Home screen / app list.')
          );
        }
        deferredPrompt = null;
      });
    });
  </script>
</body>
</html>
