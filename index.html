<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Real Unreal Story ‚Äî –ø–æ–º–æ—â—å –ê–¥–∞–º—É</title>
  <meta name="description" content="The Real Unreal Story ‚Äî –ø—Ä–∞–≤–¥–∏–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ö–∏—Ä—É—Ä–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—Å—é –∂–∏–∑–Ω—å —Å–ø–∞—Å–∞–ª –¥—Ä—É–≥–∏—Ö, –∞ —Ç–µ–ø–µ—Ä—å —Å–∞–º –±–æ—Ä–µ—Ç—Å—è –∑–∞ –∂–∏–∑–Ω—å. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å." />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Splide (–¥–ª—è –∫–∞—Ä—É—Å–µ–ª–∏ —Å–µ—Ä–¥–µ—Ü) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

  <style>
    body {
      background-image: url('images/bg.png');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
    }
    #map { height: 360px; }
    section, header, footer {
      background: rgba(0,0,0,0.85);
      border-radius: 1rem;
      margin-top: 1rem;
      padding: 1rem;
      color: #fff;
    }
    .modal-backdrop { display:none; }
    .modal-backdrop.show { display:block; }
    /* –∏–∫–æ–Ω–∫–∏-–∫–Ω–æ–ø–∫–∏ */
    .icon-btn { display:inline-flex; align-items:center; gap:8px; }
    .icon-btn svg { width:18px; height:18px; }
  </style>
</head>
<body class="text-white">
  <!-- Header -->
  <header class="max-w-5xl mx-auto px-4 py-6 flex items-center gap-3">
    <div class="text-2xl font-bold tracking-tight">The Real Unreal Story</div>
    <div class="ml-auto flex gap-2 items-center">
      <!-- Language switch -->
      <select id="lang" class="px-2 py-1 rounded bg-gray-800 text-white text-sm">
        <option value="EN">EN</option>
        <option value="ES">ES</option>
        <option value="FR">FR</option>
        <option value="PT">PT</option>
        <option value="DE">DE</option>
        <option value="IT">IT</option>
        <option value="RU" selected>RU</option>
        <option value="CN">CN</option>
        <option value="AR">AR</option>
      </select>
      <button id="audioBtn" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm">–ê—É–¥–∏–æ</button>
      <a id="donateTop" target="_blank" class="px-4 py-2 rounded-xl bg-green-600 text-white text-sm hover:bg-green-700">–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å</a>
    </div>
  </header>

  <!-- –°–æ—Ü—Å–µ—Ç–∏ -->
  <section class="max-w-5xl mx-auto px-4">
    <h2 class="text-lg font-semibold mb-3">–°–æ—Ü—Å–µ—Ç–∏</h2>
    <div class="flex items-center gap-3 flex-wrap">
      <a class="icon-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-900 shadow-sm" href="https://instagram.com" target="_blank" rel="noreferrer">
        <!-- Instagram -->
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 2.2A2.8 2.8 0 1 0 12 15.8 2.8 2.8 0 0 0 12 9.2zm4.8-2.5a1.1 1.1 0 1 1 0 2.2 1.1 1.1 0 0 1 0-2.2z"/></svg>
        Instagram
      </a>
      <a class="icon-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-900 shadow-sm" href="https://t.me/therealunrealstory" target="_blank" rel="noreferrer">
        <!-- Telegram -->
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9.96 15.47l-.4 5.63c.57 0 .81-.24 1.1-.53l2.64-2.53 5.47 4c1.01.56 1.73.27 2-.93l3.62-16.97.01-.01c.32-1.5-.54-2.08-1.52-1.72L1.2 9.65c-1.46.57-1.44 1.39-.25 1.76l5.54 1.73 12.85-8.11c.6-.39 1.15-.17.7.22"/></svg>
        Telegram
      </a>
      <a class="icon-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-900 shadow-sm" href="https://www.youtube.com" target="_blank" rel="noreferrer">
        <!-- YouTube -->
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 0 0 .5 6.2 31 31 0 0 0 0 12a31 31 0 0 0 .6 5.8 3 3 0 0 0 2.1 2.1c1.9.6 9.3.6 9.3.6s7.5 0 9.4-.6a3 3 0 0 0 2.1-2.1A31 31 0 0 0 24 12a31 31 0 0 0-.6-5.8zM9.6 15.5v-7l6.2 3.5-6.2 3.5z"/></svg>
        YouTube
      </a>
      <a class="icon-btn px-4 py-2 rounded-xl border border-gray-700 bg-gray-900 shadow-sm" href="https://open.spotify.com" target="_blank" rel="noreferrer">
        <!-- Spotify -->
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1.5a10.5 10.5 0 1 0 0 21 10.5 10.5 0 0 0 0-21zm4.84 15.2c-.19.3-.6.39-.9.2-2.44-1.5-5.52-1.84-9.13-1-.35.08-.7-.14-.78-.5-.08-.35.14-.7.5-.78 3.93-.9 7.34-.51 10.02 1.15.3.18.4.6.2.92zm1.28-2.88c-.24.38-.75.5-1.13.26-2.8-1.72-7.08-2.23-10.4-1.2-.43.13-.88-.11-1-.54-.13-.43.1-.88.54-1 3.76-1.12 8.45-.54 11.67 1.4.4.24.52.76.3 1.08zm.1-3.1c-3.23-1.92-8.6-2.1-11.69-1.14-.5.15-1.04-.14-1.2-.66-.15-.5.14-1.04.66-1.2 3.57-1.1 9.46-.86 13.2 1.37.47.28.63.9.35 1.36-.28.48-.9.63-1.32.27z"/></svg>
        Spotify
      </a>
    </div>
  </section>

  <main class="max-w-5xl mx-auto px-4">
    <!-- Hero -->
    <section id="hero">
      <h1 class="text-3xl md:text-5xl font-semibold leading-tight" data-i18n="heroTitle">
        The Real Unreal Story ‚Äî –ø–æ–º–æ—â—å –ê–¥–∞–º—É
      </h1>
      <p class="mt-4" data-i18n="heroText">
        –ü—Ä–∞–≤–¥–∏–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ö–∏—Ä—É—Ä–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—Å—é –∂–∏–∑–Ω—å —Å–ø–∞—Å–∞–ª –¥—Ä—É–≥–∏—Ö, –∞ —Ç–µ–ø–µ—Ä—å —Å–∞–º –±–æ—Ä–µ—Ç—Å—è –∑–∞ –∂–∏–∑–Ω—å. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å: –ø–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –¥–µ–Ω—å–≥–∞–º–∏, –≤—Ä–µ–º–µ–Ω–µ–º, –¥–µ–ª–æ–º –∏–ª–∏ —Å–ª–æ–≤–æ–º.
      </p>
      <div class="mt-5 flex flex-wrap items-center gap-3">
        <a id="donateHero" target="_blank" class="px-4 py-2 rounded-xl bg-green-500 hover:bg-green-600 text-sm font-medium" data-i18n="donateBtn">–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å</a>
        <button id="shareBtn" class="px-4 py-2 rounded-xl bg-gray-200 text-black text-sm hover:opacity-90" data-i18n="shareBtn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      </div>
    </section>

    <!-- –ö–∞–∫ –ø–æ–º–æ—á—å -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="howHelpTitle">–ö–∞–∫ –ø–æ–º–æ—á—å</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="p-5 rounded-2xl bg-gray-900 shadow-sm">
          <div class="text-2xl mb-2">üíö</div>
          <div class="font-medium mb-2" data-i18n="donateTitle">–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞</div>
          <div class="flex flex-wrap gap-2">
            <button data-amt="10" class="quick px-3 py-2 rounded-xl bg-green-600 text-white text-sm">$10</button>
            <button data-amt="25" class="quick px-3 py-2 rounded-xl bg-green-600 text-white text-sm">$25</button>
            <button data-amt="50" class="quick px-3 py-2 rounded-xl bg-green-600 text-white text-sm">$50</button>
            <button data-amt="100" class="quick px-3 py-2 rounded-xl bg-green-600 text-white text-sm">$100</button>
          </div>
        </div>
        <div class="p-5 rounded-2xl bg-gray-900 shadow-sm">
          <div class="text-2xl mb-2">‚è±Ô∏è</div>
          <div class="font-medium mb-2" data-i18n="timeTitle">–ü–æ–¥–∞—Ä–∏—Ç—å –≤—Ä–µ–º—è</div>
          <div class="flex gap-2 flex-wrap">
            <button data-min="5" class="pledge px-3 py-2 rounded-xl bg-gray-700 text-white text-sm">+5 –º–∏–Ω</button>
            <button data-min="15" class="pledge px-3 py-2 rounded-xl bg-gray-700 text-white text-sm">+15 –º–∏–Ω</button>
            <button data-min="60" class="pledge px-3 py-2 rounded-xl bg-gray-700 text-white text-sm">+60 –º–∏–Ω</button>
          </div>
          <div class="text-xs text-gray-400 mt-2" data-i18n="timeTotal">–ú–∏–Ω—É—Ç –æ–±–µ—â–∞–Ω–æ: <span id="minTotal">0</span></div>
        </div>
        <div class="p-5 rounded-2xl bg-gray-900 shadow-sm">
          <div class="text-2xl mb-2">üë•</div>
          <div class="font-medium mb-2" data-i18n="helpTitle">–§–∏–∑–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å</div>
          <button id="wantHelp" class="text-sm underline" data-i18n="writeLink">–Ø —Ö–æ—á—É –ø–æ–º–æ—á—å</button>
        </div>
      </div>
    </section>

    <!-- –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π Telegram -->
    <section>
      <h2 class="text-xl font-semibold mb-4">–ù–æ–≤–æ—Å—Ç–∏</h2>
      <div id="tgFeed" class="rounded-2xl bg-gray-900 border border-gray-700 p-4" style="max-height: 560px; overflow-y: auto;">
        <div class="text-sm text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π‚Ä¶</div>
      </div>
      <div class="mt-4">
        <a href="https://t.me/therealunrealstory" target="_blank" rel="noreferrer" class="px-4 py-2 rounded-xl bg-sky-600 text-white text-sm hover:bg-sky-700">
          –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π –≤ Telegram
        </a>
      </div>
    </section>

    <!-- –ö–∞—Ä—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–∫–ª–∏–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω) -->
    <section>
      <h2 class="text-xl font-semibold mb-4" data-i18n="mapTitle">üåç –ö–∞—Ä—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
      <div id="map" class="rounded-2xl shadow-sm border"></div>
      <p class="text-xs text-gray-400 mt-2">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –≤–∞—à–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏.</p>
      <div class="mt-4 grid md:grid-cols-3 gap-3">
        <input id="name" class="px-3 py-2 rounded-xl border bg-gray-800 text-white" placeholder="–ò–º—è" />
        <input id="msg" class="px-3 py-2 rounded-2xl border bg-gray-800 text-white md:col-span-2" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ (–¥–æ 140 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="140" />
      </div>
      <div class="grid md:grid-cols-3 gap-3 mt-2">
        <button id="addMark" class="px-3 py-2 rounded-xl bg-green-600 text-white text-sm col-span-1" data-i18n="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        <div class="col-span-2 text-xs text-gray-400 flex items-center">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ</div>
      </div>
      <div class="mt-2 text-sm text-gray-400" data-i18n="marksTotal">–í—Å–µ–≥–æ –æ—Ç–º–µ—Ç–æ–∫: <span id="marksCount">0</span></div>
    </section>

    <!-- –°–µ—Ä–¥—Ü–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (Splide 18/—Å–ª–∞–π–¥) -->
    <section id="contact">
      <div class="rounded-3xl bg-gray-900 p-6 shadow-sm border border-gray-700">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div class="text-lg font-semibold" data-i18n="heartsTitle">–°–µ—Ä–¥—Ü–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
          <div class="flex gap-2">
            <input id="heartName" class="px-3 py-2 rounded-xl border bg-gray-800 text-white text-sm" placeholder="–ò–º—è" />
            <button id="addHeart" class="px-4 py-2 rounded-xl bg-pink-600 text-white text-sm" data-i18n="heartsBtn">–û—Å—Ç–∞–≤–∏—Ç—å —Å–µ—Ä–¥—Ü–µ</button>
          </div>
        </div>

        <div id="heartsSplide" class="splide mt-6" aria-label="–°–µ—Ä–¥—Ü–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏">
          <div class="splide__track">
            <ul id="heartsSlides" class="splide__list"></ul>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="max-w-5xl mx-auto px-4 text-center text-sm text-gray-400">
    <span data-i18n="footerText">–°–ø–∞—Å–∏–±–æ –∑–∞ –ª—é–±—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî –¥–∞–∂–µ —Ä–µ–ø–æ—Å—Ç –º–µ–Ω—è–µ—Ç —Å—É–¥—å–±—É.</span>
  </footer>

  <!-- Hidden audio element -->
  <audio id="bgAudio" preload="auto"></audio>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50">
    <div class="min-h-full flex items-center justify-center p-4">
      <div class="bg-gray-900 text-white rounded-2xl shadow-xl border border-gray-700 max-w-lg w-full p-6 relative">
        <button id="modalClose" class="absolute right-3 top-3 text-gray-400 hover:text-white" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 class="text-lg font-semibold mb-3">–Ø —Ö–æ—á—É –ø–æ–º–æ—á—å</h3>
        <p class="text-sm text-gray-200 leading-relaxed">
          –ï—Å–ª–∏ –≤—ã –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å ‚Äî –±—É–¥—å —Ç–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
          (–º–µ–¥—Å—ë—Å—Ç—Ä—ã, —Å–∏–¥–µ–ª–∫–∏), –∏–ª–∏ –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –ª–∏—á–Ω—É—é –≤—Å—Ç—Ä–µ—á—É ‚Äî –ø–æ–∂–∞–ª—É–π—Å—Ç–∞,
          –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞: <a href="mailto:theRealUnrealStory@gmail.com" class="underline">theRealUnrealStory@gmail.com</a>.<br><br>
          –ò—Å–∫—Ä–µ–Ω–Ω–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –∫–∞–∂–¥–æ–º—É, –∫—Ç–æ –æ—Ç–∫–ª–∏–∫–Ω–µ—Ç—Å—è.
        </p>
        <div class="mt-5 text-right">
          <button id="modalOk" class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600">–û–∫</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const donateURL = "https://www.gofundme.com/f/your-campaign-slug";

    /* Donate & Share */
    document.getElementById('donateTop').href = donateURL;
    document.getElementById('donateHero').href = donateURL;
    document.querySelectorAll('.quick').forEach(btn => {
      btn.addEventListener('click', () => {
        const amt = btn.dataset.amt;
        window.open(`${donateURL}/donate?amount=${amt}`, '_blank');
      });
    });
    const shareBtn = document.getElementById('shareBtn');
    shareBtn.addEventListener('click', async () => {
      try {
        const url = location.href;
        if (navigator.share) await navigator.share({ title: 'The Real Unreal Story', url });
        else {
          await navigator.clipboard.writeText(url);
          shareBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
          setTimeout(() => shareBtn.textContent = '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è', 1500);
        }
      } catch {}
    });

    /* Helpers for local minutes */
    function safeGet(key, fallback) { try { const v=localStorage.getItem(key); return v===null?fallback:JSON.parse(v);} catch {return fallback;} }
    function safeSet(key, value){ try { localStorage.setItem(key, JSON.stringify(value)); } catch {} }

    /* Pledge minutes (local only) */
    const minEl = document.getElementById('minTotal');
    let minutes = Number(safeGet('ru_minutes', 0)) || 0;
    const updateMinutesUI = () => { if (minEl) minEl.textContent = minutes.toLocaleString(); };
    updateMinutesUI();
    document.querySelectorAll('.pledge').forEach(btn => {
      btn.addEventListener('click', () => {
        minutes += parseInt(btn.dataset.min, 10) || 0;
        safeSet('ru_minutes', minutes);
        updateMinutesUI();
      });
    });

    /* Hearts via Netlify Functions + Splide (18 –Ω–∞ —Å–ª–∞–π–¥) */
    let splide;
    function chunk(arr, size) {
      const out = [];
      for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
      return out;
    }
    function heartCard(name) {
      return `
        <div class="p-4 rounded-2xl bg-gray-800 shadow-sm border border-gray-700">
          <div class="flex items-center gap-2">
            <span class="text-xl">‚ù§Ô∏è</span>
            <div class="text-sm text-gray-300">${name || 'Anon'}</div>
          </div>
        </div>`;
    }
    function renderHeartsSlides(arr) {
      const pages = chunk(arr, 18);
      const slidesUl = document.getElementById('heartsSlides');
      slidesUl.innerHTML = pages.map(page => `
        <li class="splide__slide">
          <div class="grid md:grid-cols-3 gap-3">
            ${page.map(x => heartCard(x.name)).join('')}
          </div>
        </li>
      `).join('') || `<li class="splide__slide"><div class="text-sm text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç —Å–µ—Ä–¥–µ—Ü.</div></li>`;

      if (splide) { splide.destroy(true); }
      splide = new Splide('#heartsSplide', {
        type: 'slide',
        perPage: 1,
        perMove: 1,
        pagination: true,
        arrows: true,
        classes: { pagination: 'splide__pagination mt-4' }
      });
      splide.mount();
    }
    async function fetchHearts(){
      const res = await fetch("/.netlify/functions/hearts", { cache: "no-store" });
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    }
    async function renderHearts(){
      const arr = await fetchHearts();
      renderHeartsSlides(arr);
    }
    document.getElementById('addHeart').addEventListener('click', async () => {
      const inp = document.getElementById('heartName');
      const name = (inp.value || "").trim();
      await fetch("/.netlify/functions/hearts", {
        method:"POST", headers:{ "content-type":"application/json" },
        body: JSON.stringify({ name })
      });
      inp.value = ""; renderHearts();
    });
    renderHearts();

    /* Telegram feed */
    async function renderTgFeed() {
      try {
        const res = await fetch('/.netlify/functions/news?limit=30', { cache: 'no-store' });
        if (!res.ok) throw new Error('news API ' + res.status);
        const arr = await res.json();
        const box = document.getElementById('tgFeed');
        if (!Array.isArray(arr) || !arr.length) {
          box.innerHTML = '<div class="text-sm text-gray-400">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤.</div>';
          return;
        }
        box.innerHTML = arr.map(p => {
          const dt = p.date ? new Date(p.date) : null;
          const time = dt ? dt.toLocaleString() : '';
          const link = p.link ? `<a href="${p.link}" target="_blank" class="underline text-sky-400">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</a>` : '';
          const text = (p.text || '').replace(/\n/g, '<br>');
          return `
            <article class="mb-4 p-3 rounded-xl bg-gray-800 border border-gray-700">
              <div class="text-xs text-gray-400 mb-2">${time} ${link ? ' ¬∑ ' + link : ''}</div>
              <div class="text-sm leading-relaxed">${text}</div>
            </article>`;
        }).join('');
      } catch (e) {
        console.error(e);
        document.getElementById('tgFeed').innerHTML =
          '<div class="text-sm text-red-400">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏.</div>';
      }
    }
    renderTgFeed();

    /* Map (Leaflet) ‚Äî click required + geolocation */
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
    const layer = L.layerGroup().addTo(map);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 6);
          L.marker([latitude, longitude]).addTo(map).bindPopup("–í—ã –∑–¥–µ—Å—å").openPopup();
        },
        (err) => { console.warn("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:", err.message); }
      );
    }

    let selectedLatLng = null;
    let previewMarker = null;
    map.on('click', (e) => {
      selectedLatLng = e.latlng;
      if (previewMarker) previewMarker.remove();
      previewMarker = L.marker([selectedLatLng.lat, selectedLatLng.lng], { draggable: true })
        .addTo(map).bindPopup('–í—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–æ—á–∫–∞ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å)').openPopup();
      previewMarker.on('dragend', () => { selectedLatLng = previewMarker.getLatLng(); });
    });

    function setMarksCount(n){ const el = document.getElementById('marksCount'); if (el) el.textContent = Number.isFinite(n)? String(n): '0'; }
    async function renderMarks(){
      try{
        layer.clearLayers();
        const res = await fetch('/.netlify/functions/marks', { cache:'no-store' });
        if (!res.ok) throw new Error('API /marks ' + res.status);
        const data = await res.json();
        const arr = Array.isArray(data) ? data : [];
        setMarksCount(arr.length);
        arr.forEach(m=>{
          const lat = Number(m.lat), lon = Number(m.lon);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
          L.circleMarker([lat, lon], { radius:4, color:'lime' })
           .bindPopup(`<b>${m.name||'Anon'}</b><br>${m.message||''}`)
           .addTo(layer);
        });
      } catch(e){
        console.error('renderMarks error:', e);
        setMarksCount(0);
      }
    }
    renderMarks();

    document.getElementById('addMark').addEventListener('click', async ()=>{
      try{
        const name=document.getElementById('name').value.trim();
        const message=document.getElementById('msg').value.trim();
        if(!message) return alert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");
        if(!selectedLatLng) return alert("–°–Ω–∞—á–∞–ª–∞ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ!");

        const { lat, lng } = selectedLatLng;
        const resp = await fetch('/.netlify/functions/marks', {
          method:'POST', headers:{ 'content-type':'application/json' },
          body: JSON.stringify({ name, message, lat, lon: lng })
        });
        if (!resp.ok) {
          const t = await resp.text().catch(()=>'-');
          throw new Error('POST /marks ' + resp.status + ' ' + t);
        }
        document.getElementById('msg').value='';
        selectedLatLng = null;
        if (previewMarker) { previewMarker.remove(); previewMarker = null; }
        await renderMarks();
      } catch(e){
        console.error('addMark error:', e);
      }
    });

    /* i18n (RU full; others placeholders) */
    const dict = {
      RU: {
        heroTitle:"The Real Unreal Story ‚Äî –ø–æ–º–æ—â—å –ê–¥–∞–º—É",
        heroText:"–ü—Ä–∞–≤–¥–∏–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ö–∏—Ä—É—Ä–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—Å—é –∂–∏–∑–Ω—å —Å–ø–∞—Å–∞–ª –¥—Ä—É–≥–∏—Ö, –∞ —Ç–µ–ø–µ—Ä—å —Å–∞–º –±–æ—Ä–µ—Ç—Å—è –∑–∞ –∂–∏–∑–Ω—å. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å: –ø–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –¥–µ–Ω—å–≥–∞–º–∏, –≤—Ä–µ–º–µ–Ω–µ–º, –¥–µ–ª–æ–º –∏–ª–∏ —Å–ª–æ–≤–æ–º.",
        donateBtn:"–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å", shareBtn:"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è", howHelpTitle:"–ö–∞–∫ –ø–æ–º–æ—á—å",
        donateTitle:"–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞", timeTitle:"–ü–æ–¥–∞—Ä–∏—Ç—å –≤—Ä–µ–º—è", timeTotal:"–ú–∏–Ω—É—Ç –æ–±–µ—â–∞–Ω–æ:",
        helpTitle:"–§–∏–∑–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å", writeLink:"–Ø —Ö–æ—á—É –ø–æ–º–æ—á—å", mapTitle:"üåç –ö–∞—Ä—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏", addBtn:"–î–æ–±–∞–≤–∏—Ç—å",
        localStorage:"–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ", marksTotal:"–í—Å–µ–≥–æ –æ—Ç–º–µ—Ç–æ–∫:",
        heartsTitle:"–°–µ—Ä–¥—Ü–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏", heartsBtn:"–û—Å—Ç–∞–≤–∏—Ç—å —Å–µ—Ä–¥—Ü–µ",
        subscribeTitle:"–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è", footerText:"–°–ø–∞—Å–∏–±–æ –∑–∞ –ª—é–±—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Äî –¥–∞–∂–µ —Ä–µ–ø–æ—Å—Ç –º–µ–Ω—è–µ—Ç —Å—É–¥—å–±—É."
      },
      EN:{heroTitle:"Placeholder EN",heroText:"Placeholder EN",donateBtn:"Donate",shareBtn:"Share",howHelpTitle:"How to help",donateTitle:"Donate money",timeTitle:"Give time",timeTotal:"Minutes pledged:",helpTitle:"Physical help",writeLink:"I want to help",mapTitle:"üåç Support map",addBtn:"Add",localStorage:"Data saved in DB",marksTotal:"Total marks:",heartsTitle:"Support Heart",heartsBtn:"Leave a heart",subscribeTitle:"Subscribe",footerText:"Thanks for any support ‚Äî even sharing changes destiny."},
      ES:{heroTitle:"Placeholder ES",heroText:"Placeholder ES"},
      FR:{heroTitle:"Placeholder FR",heroText:"Placeholder FR"},
      PT:{heroTitle:"Placeholder PT",heroText:"Placeholder PT"},
      DE:{heroTitle:"Placeholder DE",heroText:"Placeholder DE"},
      IT:{heroTitle:"Placeholder IT",heroText:"Placeholder IT"},
      CN:{heroTitle:"Placeholder CN",heroText:"Placeholder CN"},
      AR:{heroTitle:"Placeholder AR",heroText:"Placeholder AR"}
    };

    const langSelect = document.getElementById("lang");
    const audio = document.getElementById("bgAudio");
    const audioBtn = document.getElementById("audioBtn");
    const audioByLang = {
      EN: "audio/ORUS-EN.mp3", ES: "audio/ORUS-ES.mp3", FR: "audio/ORUS-FR.mp3",
      PT: "audio/ORUS-PT.mp3", DE: "audio/ORUS-DE.mp3", IT: "audio/ORUS-IT.mp3",
      RU: "audio/ORUS-RU.mp3", CN: "audio/ORUS-CN.mp3", AR: "audio/ORUS-AR.mp3"
    };

    const savedLang = localStorage.getItem("site_lang") || "RU";
    langSelect.value = savedLang; applyLang(savedLang); setAudioForLang(savedLang);
    langSelect.addEventListener("change", e => {
      const l = e.target.value; localStorage.setItem("site_lang", l);
      applyLang(l); setAudioForLang(l, !audio.paused);
    });
    function applyLang(l){
      const trans=dict[l]||dict["RU"];
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key=el.getAttribute("data-i18n");
        if(trans[key]) el.innerText=trans[key];
      });
    }
    function setAudioForLang(l, autoplay=false){
      const src = audioByLang[l] || audioByLang["EN"];
      if (audio.src.endsWith(src)) { if (autoplay && audio.paused) audio.play().catch(()=>{}); return; }
      audio.pause(); audio.src = src; if (autoplay) audio.play().catch(()=>{});
    }
    audioBtn.addEventListener("click", async () => {
      if (audio.paused) { setAudioForLang(langSelect.value);
        try { await audio.play(); audioBtn.textContent = "–ü–∞—É–∑–∞"; } catch { audioBtn.textContent = "–ê—É–¥–∏–æ"; }
      } else { audio.pause(); audioBtn.textContent = "–ê—É–¥–∏–æ"; }
    });

    /* Modal */
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalClose = document.getElementById('modalClose');
    const modalOk = document.getElementById('modalOk');
    const wantHelpBtn = document.getElementById('wantHelp');
    function openModal(){ modalBackdrop.classList.add('show'); }
    function closeModal(){ modalBackdrop.classList.remove('show'); }
    wantHelpBtn.addEventListener('click', openModal);
    modalClose.addEventListener('click', closeModal);
    modalOk.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });
  </script>
</body>
</html>
